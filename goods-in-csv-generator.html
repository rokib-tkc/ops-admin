<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Goods In CSV Generator</title>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- PDF.js (NON-module build to avoid module/CORS issues) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
      --focus: 0 0 0 4px rgba(147,197,253,.35);
    }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    .wrap{ max-width: 1280px; margin: 24px auto; padding: 0 16px 28px; }
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      margin-bottom: 14px; flex-wrap: wrap;
    }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .brand h1{ margin:0; font-size: 20px; }
    .brand p{ margin:0; color:var(--muted); font-size: 13px; line-height: 1.35; }
    .pill{
      font-size: 12px; color: var(--muted);
      border:1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      background:#fafafa;
      white-space: nowrap;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }

    .grid{ display:grid; grid-template-columns: 380px 1fr; gap: 14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; margin-bottom: 10px; flex-wrap: wrap;
    }
    .sectionTitle h2{ margin:0; font-size: 15px; }

    .supplierList{ display:flex; flex-direction:column; gap:10px; }
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 12px 12px;
      text-align:left;
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{ border-color:#cbd5e1; background:#fcfcfc; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      border-color: transparent;
      color:#fff;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none !important; }

    .btn .name{ font-weight: 800; }
    .btn .meta{ font-size:12px; opacity:.85; line-height: 1.25; }

    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
      font-size: 14px;
    }
    input[type="text"]:focus, input[type="number"]:focus{
      border-color:#93c5fd;
      box-shadow: var(--focus);
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    @media (max-width: 760px){ .form{ grid-template-columns: 1fr; } }

    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; align-items:end; }
    @media (max-width: 760px){ .twoCol{ grid-template-columns: 1fr; } }

    .dropZone{
      border:2px dashed #cbd5e1;
      border-radius: 14px;
      background: #fbfbfd;
      padding: 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; min-height: 74px;
      transition: border-color .15s ease, background .15s ease;
    }
    .dropZone strong{ display:block; }
    .dropZone .dzText{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .dropZone .dzSub{ color: var(--muted); font-size: 12px; line-height: 1.25; }
    .dropZone .dzFile{ color: #374151; font-size: 12px; margin-top: 4px; word-break: break-word; }
    .dropZone.isDrag{ border-color:#60a5fa; background: rgba(147,197,253,.18); }
    .fileHidden{ display:none; }
    .fileBtn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      white-space: nowrap;
    }
    .fileBtn:hover{ border-color:#cbd5e1; background:#fcfcfc; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; align-items:center; }
    .actions .btn{ width:auto; padding: 11px 12px; text-align:center; }

    .statusRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top: 12px;
      padding: 12px;
      border:1px dashed var(--border);
      border-radius: 12px;
      background:#fbfbfb;
    }
    .statusText{ display:flex; flex-direction:column; gap:4px; }
    .statusText .small{ font-size: 12px; color: var(--muted); line-height: 1.35; }

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid var(--border);
      background:#fff;
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(22,163,74,.25); color: var(--ok); background: rgba(22,163,74,.07); }
    .badge.warn{ border-color: rgba(245,158,11,.25); color: var(--warn); background: rgba(245,158,11,.08); }
    .badge.bad{ border-color: rgba(239,68,68,.25); color: var(--bad); background: rgba(239,68,68,.08); }

    .summary{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 980px){ .summary{ grid-template-columns: repeat(2, 1fr); } }

    .kpi{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .k{ font-size: 12px; color: var(--muted); }
    .kpi .v{ font-size: 22px; font-weight: 900; margin-top: 4px; }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
    }
    thead th{
      background:#f3f4f6;
      text-align:left;
      font-size: 12px;
      color:#374151;
      padding: 10px;
      border-bottom:1px solid var(--border);
    }
    tbody td{
      padding: 10px;
      border-bottom:1px solid var(--border);
      font-size: 13px;
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .hidden{ display:none !important; }

    .spinner{
      width:16px; height:16px; border-radius:999px;
      border: 2px solid rgba(0,0,0,.12);
      border-top-color: rgba(0,0,0,.55);
      animation: spin 0.85s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    .note{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }

    /* Simple staff instructions */
    .steps{
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      padding: 12px;
      margin-top: 10px;
    }
    .steps h3{ margin:0 0 8px 0; font-size: 13px; }
    .steps ol{ margin:0; padding-left: 18px; color: var(--muted); font-size: 12px; line-height: 1.45; }
    .steps li{ margin: 4px 0; }

    /* Editor modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.55);
      display:none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(1200px, 100%);
      max-height: 92vh;
      overflow: hidden;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.2);
      display:flex;
      flex-direction: column;
    }
    .modalHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .modalHeader h3{ margin:0; font-size: 15px; }
    .modalHeader p{ margin:4px 0 0; color: var(--muted); font-size: 12px; line-height: 1.35; }

    .modalBody{
      padding: 12px 14px;
      overflow:auto;
      background: #fbfbfb;
    }
    .modalFooter{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      background:#fff;
    }

    .rowBtn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .rowBtn:hover{ border-color:#cbd5e1; background:#fcfcfc; }
    .rowBtn:disabled{ opacity:.5; cursor:not-allowed; }

    .editorTable{
      width:100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#fff;
    }
    .editorTable thead th{ position: sticky; top: 0; z-index: 1; }
    .cellInput{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 8px;
      font-size: 13px;
      outline:none;
      background:#fff;
    }
    .cellInput:focus{ border-color:#93c5fd; box-shadow: var(--focus); }
    .cellInput.qty{ text-align: right; }
    .cellInput.invalid{
      border-color: rgba(239,68,68,.6);
      box-shadow: 0 0 0 4px rgba(239,68,68,.12);
      background: rgba(239,68,68,.04);
    }

    .dragHandle{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 34px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background:#fff;
      cursor: grab;
      user-select:none;
    }
    tr.dragging{ opacity: .6; outline: 2px dashed #93c5fd; }
    tr.dropTarget{ outline: 2px solid rgba(37,99,235,.35); }

    .danger{ border-color: rgba(239,68,68,.35) !important; color: var(--bad); background: rgba(239,68,68,.06); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Goods In CSV Generator</h1>
        <p>
          Output columns:
          <span class="mono">PONum, Ref, Part, Qty, WH, Bin</span>
        </p>
      </div>
      <div class="pill">CSV: <span class="mono">UTF-8 + BOM</span></div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="sectionTitle">
          <h2>Supplier</h2>
          <span class="pill" id="selectedSupplierPill">None selected</span>
        </div>

        <div class="supplierList">
          <button class="btn" data-supplier="Saca">
            <div>
              <div class="name">Saca</div>
              <div class="meta">Excel</div>
            </div><span>→</span>
          </button>

          <button class="btn" data-supplier="Decorative Panels">
            <div>
              <div class="name">Decorative Panels</div>
              <div class="meta">PDF</div>
            </div><span>→</span>
          </button>

          <button class="btn" data-supplier="Italdecor">
            <div>
              <div class="name">Italdecor</div>
              <div class="meta">Excel</div>
            </div><span>→</span>
          </button>

          <button class="btn" data-supplier="Pieffe Union">
            <div>
              <div class="name">Pieffe Union</div>
              <div class="meta">Excel (header detect + override)</div>
            </div><span>→</span>
          </button>

          <button class="btn" data-supplier="Macfarlane">
            <div>
              <div class="name">Macfarlane</div>
              <div class="meta">PDF</div>
            </div><span>→</span>
          </button>

          <button class="btn primary" id="resetBtn" type="button">
            <div>
              <div class="name">Reset</div>
              <div class="meta">Clears screen</div>
            </div><span>⟲</span>
          </button>
        </div>

        <div class="steps">
          <h3>Instructions</h3>
          <ol>
            <li>Select supplier.</li>
            <li>Enter Ref / WH / Bin.</li>
            <li>Upload file then click <strong>Process</strong> (or use <strong>Blank table</strong>).</li>
            <li>Click <strong>Edit table</strong> if you need changes.</li>
            <li>Click <strong>Generate & Download CSV</strong>.</li>
          </ol>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="sectionTitle">
          <h2 id="rightTitle">Upload & Process</h2>
          <span class="badge" id="statusBadge">Idle</span>
        </div>

        <div class="form">
          <div>
            <label for="ref">Delivery Ref *</label>
            <input id="ref" type="text" placeholder="e.g. SACAFAWB0558" autocomplete="off" />
          </div>
          <div>
            <label for="wh">Warehouse (WH) *</label>
            <input id="wh" type="text" placeholder="e.g. 6Q" autocomplete="off" />
          </div>
          <div>
            <label for="bin">Bin *</label>
            <input id="bin" type="text" placeholder="e.g. PRE" autocomplete="off" />
          </div>
        </div>

        <div class="twoCol hidden" id="pieffeOverrideRow">
          <div>
            <label for="pieffeHeaderOverride">Pieffe header row override (optional)</label>
            <input id="pieffeHeaderOverride" type="number" min="1" step="1" placeholder="e.g. 22" />
            <div class="note" style="margin-top:6px;">Enter the Excel row number where the header is.</div>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="pill" id="pieffeOverrideHint">Auto-detect enabled</div>
          </div>
        </div>

        <div class="twoCol">
          <div class="dropZone" id="dropZone" role="button" tabindex="0">
            <div class="dzText">
              <strong>Drop file here (optional)</strong>
              <div class="dzSub" id="dropSub">Or click “Choose file”.</div>
              <div class="dzFile mono" id="fileName">No file selected</div>
            </div>
            <button class="fileBtn" id="chooseFileBtn" type="button">Choose file</button>
          </div>

          <div>
            <label>Hidden file input</label>
            <input id="fileInput" class="fileHidden" type="file" />
            <div class="note">Output: <span class="mono" id="outputNameHint">REF.csv</span></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="blankTableBtn" type="button">Blank table</button>
          <button class="btn primary" id="processBtn" type="button" disabled>Process</button>
          <button class="btn" id="editBtn" type="button" disabled>Edit table</button>
          <button class="btn primary" id="generateBtn" type="button" disabled>Generate & Download CSV</button>
          <button class="btn danger" id="clearFileBtn" type="button" disabled>Clear file</button>
        </div>

        <div class="statusRow">
          <div class="statusText">
            <div id="statusLine"><strong>Status:</strong> Waiting</div>
            <div class="small" id="statusDetail">Select supplier or use Blank table.</div>
          </div>
          <div id="spinner" class="spinner hidden"></div>
        </div>

        <div class="summary">
          <div class="kpi"><div class="k">Total Lines</div><div class="v" id="kpiTotal">—</div></div>
          <div class="kpi"><div class="k">Captured Lines</div><div class="v" id="kpiCaptured">—</div></div>
          <div class="kpi"><div class="k">Ignored Lines</div><div class="v" id="kpiIgnored">—</div></div>
          <div class="kpi"><div class="k">Total Pallets</div><div class="v" id="kpiPallets">—</div></div>
        </div>

        <div class="note">Preview (first 25 rows). Rows: <span class="mono" id="rowCount">0</span></div>

        <table id="previewTable" class="hidden">
          <thead>
            <tr>
              <th>PONum</th><th>Ref</th><th>Part</th><th>Qty</th><th>WH</th><th>Bin</th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Editor modal -->
  <div class="modalOverlay" id="editorOverlay">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <h3>Edit table</h3>
          <p>Edit values, add/remove/duplicate rows, drag to reorder. Qty must be numeric.</p>
        </div>
        <button class="rowBtn" id="editorCloseX" type="button">Close</button>
      </div>

      <div class="modalBody">
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; margin-bottom:10px;">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="rowBtn" id="addRowBtn" type="button">+ Add row</button>
            <button class="rowBtn" id="add5RowsBtn" type="button">+ Add 5 rows</button>
            <button class="rowBtn" id="fillDefaultsBtn" type="button">Fill blank Ref/WH/Bin</button>
          </div>
          <div class="pill">Rows: <span class="mono" id="editorRowKpi">0</span></div>
        </div>

        <table class="editorTable">
          <thead>
            <tr>
              <th style="width:52px;">Move</th>
              <th style="width:160px;">PONum</th>
              <th style="width:160px;">Ref</th>
              <th style="width:220px;">Part</th>
              <th style="width:120px;">Qty</th>
              <th style="width:120px;">WH</th>
              <th style="width:120px;">Bin</th>
              <th style="width:310px;">Actions</th>
            </tr>
          </thead>
          <tbody id="editorBody"></tbody>
        </table>
      </div>

      <div class="modalFooter">
        <button class="rowBtn" id="cancelEditBtn" type="button">Cancel</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="rowBtn danger" id="deleteAllRowsBtn" type="button">Delete all rows</button>
          <button class="rowBtn" id="confirmEditBtn" type="button">Confirm changes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // PDF.js worker setup (global build)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
    }

    // -----------------------------
    // State
    // -----------------------------
    let selectedSupplier = null;
    let selectedFile = null;

    let dataRows = [];
    let lastMetrics = { totalLines:null, captured:null, ignored:null, totalPallets:null, extraInfo:null };

    // -----------------------------
    // Elements
    // -----------------------------
    const supplierButtons = document.querySelectorAll("[data-supplier]");
    const selectedSupplierPill = document.getElementById("selectedSupplierPill");
    const rightTitle = document.getElementById("rightTitle");

    const refInput = document.getElementById("ref");
    const whInput = document.getElementById("wh");
    const binInput = document.getElementById("bin");

    const pieffeOverrideRow = document.getElementById("pieffeOverrideRow");
    const pieffeHeaderOverride = document.getElementById("pieffeHeaderOverride");
    const pieffeOverrideHint = document.getElementById("pieffeOverrideHint");

    const dropZone = document.getElementById("dropZone");
    const chooseFileBtn = document.getElementById("chooseFileBtn");
    const fileInput = document.getElementById("fileInput");
    const fileName = document.getElementById("fileName");
    const dropSub = document.getElementById("dropSub");

    const blankTableBtn = document.getElementById("blankTableBtn");
    const processBtn = document.getElementById("processBtn");
    const editBtn = document.getElementById("editBtn");
    const generateBtn = document.getElementById("generateBtn");
    const clearFileBtn = document.getElementById("clearFileBtn");
    const resetBtn = document.getElementById("resetBtn");

    const statusBadge = document.getElementById("statusBadge");
    const statusLine = document.getElementById("statusLine");
    const statusDetail = document.getElementById("statusDetail");
    const spinner = document.getElementById("spinner");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiCaptured = document.getElementById("kpiCaptured");
    const kpiIgnored = document.getElementById("kpiIgnored");
    const kpiPallets = document.getElementById("kpiPallets");

    const previewTable = document.getElementById("previewTable");
    const previewBody = document.getElementById("previewBody");
    const outputNameHint = document.getElementById("outputNameHint");
    const rowCount = document.getElementById("rowCount");

    // Editor modal
    const editorOverlay = document.getElementById("editorOverlay");
    const editorBody = document.getElementById("editorBody");
    const editorRowKpi = document.getElementById("editorRowKpi");
    const editorCloseX = document.getElementById("editorCloseX");
    const addRowBtn = document.getElementById("addRowBtn");
    const add5RowsBtn = document.getElementById("add5RowsBtn");
    const fillDefaultsBtn = document.getElementById("fillDefaultsBtn");
    const deleteAllRowsBtn = document.getElementById("deleteAllRowsBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const confirmEditBtn = document.getElementById("confirmEditBtn");

    // -----------------------------
    // Supplier config
    // -----------------------------
    const supplierConfig = {
      "Saca": { title: "Saca", accept: [".xlsx",".xls"], hint: "Accepted: Excel", processor: processSacaExcel },
      "Decorative Panels": { title: "Decorative Panels", accept: [".pdf"], hint: "Accepted: PDF (text PDF)", processor: processDecorativePanelsPdf },
      "Italdecor": { title: "Italdecor", accept: [".xlsx",".xls"], hint: "Accepted: Excel", processor: processItaldecorExcel },
      "Pieffe Union": { title: "Pieffe Union", accept: [".xlsx",".xls"], hint: "Accepted: Excel (header detect + override)", processor: processPieffeUnionExcelAutoHeaderOrOverride },
      "Macfarlane": { title: "Macfarlane", accept: [".pdf"], hint: "Accepted: PDF (text PDF)", processor: processMacfarlanePdf }
    };

    // -----------------------------
    // UI helpers
    // -----------------------------
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function setBadge(kind, text){
      statusBadge.className = "badge";
      if (kind) statusBadge.classList.add(kind);
      statusBadge.textContent = text;
    }
    function setStatus(main, detail, busy=false, badgeKind=null, badgeText=""){
      statusLine.innerHTML = `<strong>Status:</strong> ${escapeHtml(main)}`;
      statusDetail.textContent = detail || "";
      spinner.classList.toggle("hidden", !busy);
      if (badgeText) setBadge(badgeKind, badgeText);
    }
    function normaliseInputs(){
      const ref = (refInput.value || "").trim().toUpperCase();
      const wh = (whInput.value || "").trim().toUpperCase();
      const bin = (binInput.value || "").trim().toUpperCase();
      refInput.value = ref;
      whInput.value = wh;
      binInput.value = bin;
      return { ref, wh, bin };
    }
    function updateOutputNameHint(){
      const { ref } = normaliseInputs();
      outputNameHint.textContent = `${(ref || "REF")}.csv`;
    }
    function updatePieffeOverrideUI(){
      const isPieffe = selectedSupplier === "Pieffe Union";
      pieffeOverrideRow.classList.toggle("hidden", !isPieffe);
      const v = (pieffeHeaderOverride.value || "").trim();
      pieffeOverrideHint.textContent = v ? `Override set: row ${v}` : "Auto-detect enabled";
    }
    function updateFileUI(){
      if (!selectedSupplier){
        fileName.textContent = "No file selected";
        dropSub.textContent = "Select supplier or use Blank table.";
        clearFileBtn.disabled = true;
        return;
      }
      dropSub.textContent = supplierConfig[selectedSupplier].hint;
      fileName.textContent = selectedFile ? selectedFile.name : "No file selected";
      clearFileBtn.disabled = !selectedFile;
    }
    function clearKpis(){
      kpiTotal.textContent = "—";
      kpiCaptured.textContent = "—";
      kpiIgnored.textContent = "—";
      kpiPallets.textContent = "—";
    }
    function setDataRows(rows, metrics){
      dataRows = Array.isArray(rows) ? rows : [];
      rowCount.textContent = String(dataRows.length);

      if (metrics){
        lastMetrics = metrics;
        kpiTotal.textContent = String(metrics.totalLines ?? "—");
        kpiCaptured.textContent = String(metrics.captured ?? "—");
        kpiIgnored.textContent = String(metrics.ignored ?? "—");
        kpiPallets.textContent = metrics.totalPallets == null ? "—" : String(metrics.totalPallets);
      } else {
        clearKpis();
      }

      renderPreview();
      updateButtons();
    }
    function renderPreview(){
      previewBody.innerHTML = "";
      const show = dataRows.slice(0,25);
      for (const r of show){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.PONum)}</td>
          <td>${escapeHtml(r.Ref)}</td>
          <td>${escapeHtml(r.Part)}</td>
          <td>${escapeHtml(r.Qty)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.Bin)}</td>
        `;
        previewBody.appendChild(tr);
      }
      previewTable.classList.toggle("hidden", dataRows.length === 0);
    }
    function updateButtons(){
      const { ref, wh, bin } = normaliseInputs();
      processBtn.disabled = !(selectedSupplier && selectedFile && ref && wh && bin);
      editBtn.disabled = dataRows.length === 0;
      generateBtn.disabled = dataRows.length === 0;
      blankTableBtn.disabled = false;
    }

    // -----------------------------
    // CSV helpers
    // -----------------------------
    function toCsv(rows){
      const headers = ["PONum","Ref","Part","Qty","WH","Bin"];
      const esc = (v) => {
        const s = String(v ?? "");
        if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      const lines = [headers.join(",")];
      for (const r of rows){
        lines.push(headers.map(h => esc(r[h])).join(","));
      }
      return lines.join("\r\n");
    }
    function downloadCsv(text, filename){
      const bom = "\uFEFF";
      const blob = new Blob([bom + text], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 15000);
    }

    function isDigitsOnly(s){ return /^\d+$/.test(String(s ?? "").trim()); }

    function validateRowsForExport(rows){
      for (let i=0; i<rows.length; i++){
        const r = rows[i];
        const req = ["PONum","Ref","Part","Qty","WH","Bin"];
        for (const k of req){
          if (!String(r[k] ?? "").trim()) return `Row ${i+1} is missing ${k}.`;
        }
        if (!isDigitsOnly(r.Qty)) return `Row ${i+1} has invalid Qty "${r.Qty}" (numbers only).`;
      }
      return null;
    }

    // -----------------------------
    // File readers
    // -----------------------------
    function readFileAsArrayBuffer(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = () => reject(fr.error);
        fr.readAsArrayBuffer(file);
      });
    }

    async function pdfToTextLines(file){
      if (!window.pdfjsLib) throw new Error("PDF engine failed to load.");
      const buf = await readFileAsArrayBuffer(file);
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      const allLines = [];
      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();

        const items = content.items
          .filter(it => it.str && it.str.trim() !== "")
          .map(it => ({ str: it.str.trim(), x: it.transform[4], y: it.transform[5] }));

        const byY = new Map();
        for (const it of items){
          const key = Math.round(it.y);
          if (!byY.has(key)) byY.set(key, []);
          byY.get(key).push(it);
        }

        const ys = Array.from(byY.keys()).sort((a,b)=> b-a);
        for (const y of ys){
          const row = byY.get(y).sort((a,b)=>a.x-b.x).map(it=>it.str).join(" ");
          allLines.push(row);
        }
      }
      return allLines;
    }

    function excelToJsonRows(arrayBuffer, sheetIndex=0, opts={}){
      const wb = XLSX.read(arrayBuffer, { type:"array" });
      const ws = wb.Sheets[wb.SheetNames[sheetIndex]];
      return XLSX.utils.sheet_to_json(ws, opts);
    }
    function excelToMatrix(arrayBuffer, sheetIndex=0){
      const wb = XLSX.read(arrayBuffer, { type:"array" });
      const ws = wb.Sheets[wb.SheetNames[sheetIndex]];
      return XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: null });
    }

    // -----------------------------
    // Processors (same logic)
    // -----------------------------
    async function processMacfarlanePdf(ref, wh, bin, file){
      const lines = await pdfToTextLines(file);
      const out = [];
      let totalLines=0, captured=0, ignored=0;
      let stop=false;

      for (const line of lines){
        if (line.includes("Outstanding goods")) stop = true;
        if (stop){ ignored++; totalLines++; continue; }

        const parts = line.split(/\s+/);
        if (parts.length >= 4 && /^\d+$/.test(parts[1]) && parts[1].length > 4){
          const po_ref = parts[1];
          const product_code = parts[2];
          const qty = parts[3];
          if (/^\d+$/.test(po_ref) && /^[A-Za-z0-9]+$/.test(product_code) && /^\d+$/.test(qty)){
            out.push({ PONum:po_ref, Ref:ref, Part:product_code, Qty:qty, WH:wh, Bin:bin });
            captured++;
          } else ignored++;
        } else ignored++;
        totalLines++;
      }
      return { rows: out, metrics:{ totalLines, captured, ignored, totalPallets:null, extraInfo:null } };
    }

    async function processDecorativePanelsPdf(ref, wh, bin, file){
      const lines = await pdfToTextLines(file);
      const out = [];
      let totalProductLines=0, captured=0, ignored=0, totalPallets=0;

      for (const line of lines){
        const parts = line.split(/\s+/);
        if (parts.length >= 5 && /^\d+$/.test(parts[0]) && parts[0].length >= 5){
          totalProductLines++;
          const po_ref = parts[0];
          const product_code = parts[1];

          let qPer=null, num=null, qty=null;
          for (let i=2; i<parts.length-2; i++){
            if (/^\d+$/.test(parts[i]) && /^\d+$/.test(parts[i+1]) && /^\d+$/.test(parts[i+2])){
              qPer = parseInt(parts[i],10);
              num  = parseInt(parts[i+1],10);
              qty  = parseInt(parts[i+2],10);
              totalPallets += num;
              break;
            }
          }
          if (qPer==null || num==null || qty==null){ ignored++; continue; }

          for (let i=0; i<num; i++){
            const finalQty = (i === num-1) ? (qty - (qPer * (num-1))) : qPer;
            out.push({ PONum:po_ref, Ref:ref, Part:product_code, Qty:String(finalQty), WH:wh, Bin:bin });
          }
          captured++;
        }
      }
      return { rows: out, metrics:{ totalLines: totalProductLines, captured, ignored, totalPallets, extraInfo:null } };
    }

    async function processSacaExcel(ref, wh, bin, file){
      const buf = await readFileAsArrayBuffer(file);
      const rows = excelToJsonRows(buf, 0, { defval:null });
      const out = [];
      let captured=0, ignored=0;

      for (const r of rows){
        const po_ref = r["Numero conferma"];
        const product_code = r["Articolo esterno"];
        const qty = r["Quantità spuntata"];
        if (po_ref == null || product_code == null || qty == null){ ignored++; continue; }
        out.push({ PONum:po_ref, Ref:ref, Part:product_code, Qty:String(qty), WH:wh, Bin:bin });
        captured++;
      }
      return { rows: out, metrics:{ totalLines: rows.length, captured, ignored, totalPallets:null, extraInfo:null } };
    }

    async function processItaldecorExcel(ref, wh, bin, file){
      const buf = await readFileAsArrayBuffer(file);
      const matrix = excelToMatrix(buf, 0);
      const out = [];
      let currentPO=null;
      let total=0, captured=0, ignored=0;

      for (const row of matrix){
        const c0 = row[0];
        const c12 = row[12];

        if (typeof c0 === "string"){
          const skip = ["Codice","Descrizione","SEGUE","DPS","TIR"];
          if (skip.some(k => c0.includes(k))) continue;
          if (c0.includes("-->ORD. n.")){
            try{
              const after = c0.split("ORD. n.")[1];
              currentPO = after.split("/")[0].trim();
            }catch{ currentPO=null; }
          }
        }

        if (c0 != null && c12 != null){
          total++;
          try{
            out.push({ PONum:currentPO, Ref:ref, Part:String(c0), Qty:String(c12), WH:wh, Bin:bin });
            captured++;
          }catch{ ignored++; }
        }
      }
      return { rows: out, metrics:{ totalLines: total, captured, ignored, totalPallets:null, extraInfo:null } };
    }

    function normaliseHeaderCell(v){
      return String(v ?? "").trim().replace(/\s+/g," ").toLowerCase();
    }
    function findHeaderRowIndex(matrix, required, maxScan=120){
      const target = required.map(h=>h.toLowerCase());
      const limit = Math.min(matrix.length, maxScan);
      for (let r=0; r<limit; r++){
        const row = matrix[r] || [];
        const norm = row.map(normaliseHeaderCell);
        if (target.every(t => norm.includes(t))) return r;
      }
      return -1;
    }

    async function processPieffeUnionExcelAutoHeaderOrOverride(ref, wh, bin, file){
      const buf = await readFileAsArrayBuffer(file);
      const matrix = excelToMatrix(buf, 0);

      const required = ["Your PO","Item Code","Qty"];
      const overrideText = (pieffeHeaderOverride.value || "").trim();

      let headerRowIndex = -1;
      let extraInfo = null;

      if (overrideText){
        const override = parseInt(overrideText,10);
        if (!Number.isFinite(override) || override < 1) throw new Error("Pieffe override must be a row number (e.g. 22).");
        headerRowIndex = override - 1;
        if (headerRowIndex >= matrix.length) throw new Error("Pieffe override row is beyond the sheet.");
        extraInfo = `Header override used (row ${override})`;
      } else {
        headerRowIndex = findHeaderRowIndex(matrix, required, 120);
        if (headerRowIndex === -1) throw new Error("Could not auto-detect Pieffe header row. Use override and try again.");
        extraInfo = `Header detected on row ${headerRowIndex + 1}`;
      }

      const header = (matrix[headerRowIndex] || []).map(h => String(h ?? "").trim());
      const headerNorm = header.map(normaliseHeaderCell);

      const idxPO = headerNorm.indexOf("your po");
      const idxItem = headerNorm.indexOf("item code");
      const idxQty = headerNorm.indexOf("qty");

      if (idxPO === -1 || idxItem === -1 || idxQty === -1) throw new Error("Pieffe header row does not contain required columns.");

      const dataPart = matrix.slice(headerRowIndex + 1).filter(r => (r||[]).some(v => v != null && String(v).trim() !== ""));
      const out = [];
      let captured=0, ignored=0;

      for (const row of dataPart){
        const po = row[idxPO];
        const item = row[idxItem];
        const qty = row[idxQty];
        if (po == null || item == null || qty == null){ ignored++; continue; }
        out.push({ PONum:po, Ref:ref, Part:item, Qty:String(qty), WH:wh, Bin:bin });
        captured++;
      }

      return { rows: out, metrics:{ totalLines: dataPart.length, captured, ignored, totalPallets:null, extraInfo } };
    }

    // -----------------------------
    // File validation
    // -----------------------------
    function setSelectedFile(file){
      if (!selectedSupplier) throw new Error("Select supplier first.");
      const name = (file?.name || "").toLowerCase();
      const allowed = supplierConfig[selectedSupplier].accept;
      if (!allowed.some(ext => name.endsWith(ext))) {
        throw new Error(`Wrong file type for ${selectedSupplier}. Expected: ${allowed.join(", ")}`);
      }
      selectedFile = file;
      updateFileUI();
      updateButtons();
      setStatus("File selected", "Click Process.", false, null, "Idle");
    }

    // -----------------------------
    // Editor
    // -----------------------------
    let editorDraftRows = [];
    let dragFromIndex = null;

    function defaultRowTemplate(){
      const { ref, wh, bin } = normaliseInputs();
      return { PONum:"", Ref:ref||"", Part:"", Qty:"", WH:wh||"", Bin:bin||"" };
    }

    function openEditor(){
      editorDraftRows = dataRows.map(r => ({
        PONum:String(r.PONum??""), Ref:String(r.Ref??""), Part:String(r.Part??""),
        Qty:String(r.Qty??""), WH:String(r.WH??""), Bin:String(r.Bin??"")
      }));
      renderEditorTable();
      editorRowKpi.textContent = String(editorDraftRows.length);
      editorOverlay.classList.add("show");
      setTimeout(() => {
        const first = editorBody.querySelector("input");
        if (first) first.focus();
      }, 0);
    }

    function closeEditor(){
      editorOverlay.classList.remove("show");
      editorDraftRows = [];
    }

    function renderEditorTable(){
      editorBody.innerHTML = "";

      for (let i=0; i<editorDraftRows.length; i++){
        const r = editorDraftRows[i];
        const tr = document.createElement("tr");
        tr.setAttribute("draggable","true");
        tr.setAttribute("data-idx", String(i));

        tr.innerHTML = `
          <td><div class="dragHandle" title="Drag to move">⋮⋮</div></td>
          <td><input class="cellInput" data-row="${i}" data-key="PONum" value="${escapeHtml(r.PONum)}"></td>
          <td><input class="cellInput" data-row="${i}" data-key="Ref" value="${escapeHtml(r.Ref)}"></td>
          <td><input class="cellInput" data-row="${i}" data-key="Part" value="${escapeHtml(r.Part)}"></td>
          <td><input class="cellInput qty" inputmode="numeric" data-row="${i}" data-key="Qty" value="${escapeHtml(r.Qty)}"></td>
          <td><input class="cellInput" data-row="${i}" data-key="WH" value="${escapeHtml(r.WH)}"></td>
          <td><input class="cellInput" data-row="${i}" data-key="Bin" value="${escapeHtml(r.Bin)}"></td>
          <td style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="rowBtn" type="button" data-action="up" data-i="${i}" ${i===0?"disabled":""}>↑</button>
            <button class="rowBtn" type="button" data-action="down" data-i="${i}" ${i===editorDraftRows.length-1?"disabled":""}>↓</button>
            <button class="rowBtn" type="button" data-action="dup" data-i="${i}">Duplicate</button>
            <button class="rowBtn" type="button" data-action="addAfter" data-i="${i}">Add after</button>
            <button class="rowBtn danger" type="button" data-action="del" data-i="${i}">Delete</button>
          </td>
        `;
        editorBody.appendChild(tr);
      }

      // inputs
      editorBody.querySelectorAll(".cellInput").forEach(inp => {
        inp.addEventListener("input", () => {
          const rowIdx = parseInt(inp.getAttribute("data-row"),10);
          const key = inp.getAttribute("data-key");
          if (!Number.isFinite(rowIdx) || !key) return;

          if (key === "Qty"){
            // digits only
            const cleaned = inp.value.replace(/[^\d]/g,"");
            if (inp.value !== cleaned) inp.value = cleaned;
            inp.classList.toggle("invalid", inp.value.trim() !== "" && !isDigitsOnly(inp.value));
          }

          editorDraftRows[rowIdx][key] = inp.value;
        });
      });

      // row actions
      editorBody.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          const i = parseInt(btn.getAttribute("data-i"),10);
          if (!Number.isFinite(i)) return;

          if (action === "del"){ editorDraftRows.splice(i,1); renderEditorTable(); editorRowKpi.textContent = String(editorDraftRows.length); return; }
          if (action === "dup"){ editorDraftRows.splice(i+1,0,{...editorDraftRows[i]}); renderEditorTable(); editorRowKpi.textContent = String(editorDraftRows.length); return; }
          if (action === "addAfter"){ editorDraftRows.splice(i+1,0,defaultRowTemplate()); renderEditorTable(); editorRowKpi.textContent = String(editorDraftRows.length); return; }
          if (action === "up" && i>0){ const t=editorDraftRows[i-1]; editorDraftRows[i-1]=editorDraftRows[i]; editorDraftRows[i]=t; renderEditorTable(); return; }
          if (action === "down" && i<editorDraftRows.length-1){ const t=editorDraftRows[i+1]; editorDraftRows[i+1]=editorDraftRows[i]; editorDraftRows[i]=t; renderEditorTable(); return; }
        });
      });

      // drag and drop reorder
      const rowsEls = editorBody.querySelectorAll("tr[draggable='true']");
      rowsEls.forEach(tr => {
        tr.addEventListener("dragstart", (e) => {
          dragFromIndex = parseInt(tr.getAttribute("data-idx"),10);
          tr.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
          try{ e.dataTransfer.setData("text/plain", String(dragFromIndex)); }catch{}
        });
        tr.addEventListener("dragend", () => {
          dragFromIndex = null;
          rowsEls.forEach(r => r.classList.remove("dragging","dropTarget"));
        });
        tr.addEventListener("dragover", (e) => {
          e.preventDefault();
          tr.classList.add("dropTarget");
        });
        tr.addEventListener("dragleave", () => tr.classList.remove("dropTarget"));
        tr.addEventListener("drop", (e) => {
          e.preventDefault();
          tr.classList.remove("dropTarget");
          let from = dragFromIndex;
          if (!Number.isFinite(from)) from = parseInt(e.dataTransfer.getData("text/plain"),10);
          const to = parseInt(tr.getAttribute("data-idx"),10);
          if (!Number.isFinite(from) || !Number.isFinite(to) || from===to) return;

          const [moved] = editorDraftRows.splice(from,1);
          editorDraftRows.splice(to,0,moved);
          renderEditorTable();
        });
      });
    }

    // -----------------------------
    // Processing + export
    // -----------------------------
    async function processFile(){
      const { ref, wh, bin } = normaliseInputs();
      if (!selectedSupplier) throw new Error("Select supplier first.");
      if (!selectedFile) throw new Error("Choose a file first.");
      if (!ref || !wh || !bin) throw new Error("Ref, WH and Bin are required.");

      setStatus("Processing…", "Reading file and building table.", true, "warn", "Processing");
      const result = await supplierConfig[selectedSupplier].processor(ref, wh, bin, selectedFile);

      setStatus("Processed", `Loaded ${result.rows.length} rows. Edit table if needed.`, false, "ok", "Ready");
      setDataRows(result.rows, result.metrics);
    }

    function generateAndDownload(){
      const { ref } = normaliseInputs();
      if (!dataRows.length) return;

      const err = validateRowsForExport(dataRows);
      if (err){
        alert(err + "\n\nOpen Edit table and fix it.");
        return;
      }

      const csvText = toCsv(dataRows);
      downloadCsv(csvText, `${(ref || "REF")}.csv`);
      setStatus("Downloaded", "CSV downloaded.", false, "ok", "Done");
    }

    function startBlankTable(){
      const base = [];
      for (let i=0; i<5; i++) base.push(defaultRowTemplate());
      setDataRows(base, { totalLines:5, captured:5, ignored:0, totalPallets:null, extraInfo:"Blank table" });
      openEditor();
      setStatus("Blank table", "Enter rows, confirm changes, then download CSV.", false, "warn", "Manual");
    }

    function clearFile(){
      selectedFile = null;
      fileInput.value = "";
      updateFileUI();
      updateButtons();
      setStatus("File cleared", "Choose another file or use Blank table.", false, null, "Idle");
    }

    function resetAll(){
      selectedSupplier = null;
      selectedFile = null;
      supplierButtons.forEach(b => b.classList.remove("primary"));
      selectedSupplierPill.textContent = "None selected";
      rightTitle.textContent = "Upload & Process";
      refInput.value = ""; whInput.value=""; binInput.value="";
      pieffeHeaderOverride.value = "";
      updatePieffeOverrideUI();
      updateFileUI();
      clearKpis();
      setDataRows([], null);
      updateOutputNameHint();
      setStatus("Waiting", "Select supplier or use Blank table.", false, null, "Idle");
    }

    // -----------------------------
    // Wiring
    // -----------------------------
    supplierButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const supplier = btn.getAttribute("data-supplier");
        selectedSupplier = supplier;

        supplierButtons.forEach(b => b.classList.remove("primary"));
        btn.classList.add("primary");

        selectedSupplierPill.textContent = supplier;
        rightTitle.textContent = supplier;

        selectedFile = null;
        fileInput.value = "";
        updatePieffeOverrideUI();
        updateFileUI();
        updateButtons();
        setStatus("Supplier selected", "Choose a file or use Blank table.", false, null, "Idle");
      });
    });

    [refInput, whInput, binInput].forEach(inp => {
      inp.addEventListener("input", () => { normaliseInputs(); updateOutputNameHint(); updateButtons(); });
      inp.addEventListener("blur", () => { normaliseInputs(); updateOutputNameHint(); updateButtons(); });
    });
    pieffeHeaderOverride.addEventListener("input", updatePieffeOverrideUI);

    chooseFileBtn.addEventListener("click", () => {
      if (!selectedSupplier){
        setStatus("Select supplier first", "Or use Blank table.", false, "warn", "Waiting");
        return;
      }
      // set accept based on supplier
      fileInput.accept = supplierConfig[selectedSupplier].accept.join(",");
      fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      try{ setSelectedFile(f); }
      catch(err){ setStatus("Error", err.message, false, "bad", "Error"); }
    });

    // Drag & drop
    ["dragenter","dragover"].forEach(ev => dropZone.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add("isDrag");
    }));
    ["dragleave","drop"].forEach(ev => dropZone.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove("isDrag");
    }));
    dropZone.addEventListener("drop", (e) => {
      if (!selectedSupplier){
        setStatus("Select supplier first", "Or use Blank table.", false, "warn", "Waiting");
        return;
      }
      const f = e.dataTransfer?.files?.[0];
      if (!f) return;
      try{ setSelectedFile(f); }
      catch(err){ setStatus("Error", err.message, false, "bad", "Error"); }
    });

    blankTableBtn.addEventListener("click", startBlankTable);
    clearFileBtn.addEventListener("click", clearFile);
    resetBtn.addEventListener("click", resetAll);

    processBtn.addEventListener("click", async () => {
      try{ await processFile(); }
      catch(err){ setStatus("Error", err.message || "Something went wrong.", false, "bad", "Error"); }
    });

    editBtn.addEventListener("click", () => {
      if (!dataRows.length) return;
      openEditor();
    });

    generateBtn.addEventListener("click", generateAndDownload);

    // Editor controls
    editorCloseX.addEventListener("click", closeEditor);
    cancelEditBtn.addEventListener("click", closeEditor);
    confirmEditBtn.addEventListener("click", () => {
      // clean + apply
      const cleaned = editorDraftRows
        .map(r => ({
          PONum: String(r.PONum ?? "").trim(),
          Ref: String(r.Ref ?? "").trim().toUpperCase(),
          Part: String(r.Part ?? "").trim(),
          Qty: String(r.Qty ?? "").trim(),
          WH: String(r.WH ?? "").trim().toUpperCase(),
          Bin: String(r.Bin ?? "").trim().toUpperCase()
        }))
        .filter(r => Object.values(r).some(v => String(v).trim() !== ""));
      setDataRows(cleaned, lastMetrics);
      closeEditor();
      setStatus("Table updated", "Now you can download the CSV.", false, "ok", "Ready");
    });

    addRowBtn.addEventListener("click", () => {
      editorDraftRows.push(defaultRowTemplate());
      renderEditorTable();
      editorRowKpi.textContent = String(editorDraftRows.length);
    });
    add5RowsBtn.addEventListener("click", () => {
      for (let i=0; i<5; i++) editorDraftRows.push(defaultRowTemplate());
      renderEditorTable();
      editorRowKpi.textContent = String(editorDraftRows.length);
    });
    fillDefaultsBtn.addEventListener("click", () => {
      const { ref, wh, bin } = normaliseInputs();
      for (const r of editorDraftRows){
        if (!String(r.Ref ?? "").trim() && ref) r.Ref = ref;
        if (!String(r.WH ?? "").trim() && wh) r.WH = wh;
        if (!String(r.Bin ?? "").trim() && bin) r.Bin = bin;
      }
      renderEditorTable();
    });
    deleteAllRowsBtn.addEventListener("click", () => {
      if (!confirm("Delete all rows?")) return;
      editorDraftRows = [];
      renderEditorTable();
      editorRowKpi.textContent = "0";
    });

    editorOverlay.addEventListener("click", (e) => { if (e.target === editorOverlay) closeEditor(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape" && editorOverlay.classList.contains("show")) closeEditor(); });

    // Init
    setBadge(null, "Idle");
    setStatus("Waiting", "Select supplier or use Blank table.", false, null, "Idle");
    updateOutputNameHint();
    updatePieffeOverrideUI();
    updateFileUI();
    setDataRows([], null);
    updateButtons();
  </script>
</body>
</html>
