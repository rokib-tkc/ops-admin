<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inter-Site Stock Transfers</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#d1d5db;

      --accent:#2563eb;
      --ok:#16a34a;
      --warn:#f59e0b;

      --sent:#16a34a;
      --dropped:#f59e0b;
      --cancel:#ef4444;

      --shadow: 0 6px 16px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    *{ box-sizing:border-box; font-family: Arial, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    header{
      background:var(--card);
      box-shadow:var(--shadow);
      padding:14px 18px;
      position:sticky; top:0; z-index:20;
    }
    .wrap{ max-width:1200px; margin:0 auto; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ font-size:18px; margin:0; }

    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .tabs{ display:flex; gap:8px; }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{
      border-color:var(--accent);
      color:var(--accent);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.danger{
      background:var(--cancel);
      border-color:var(--cancel);
      color:#fff;
    }
    .btn:disabled{ opacity:0.55; cursor:not-allowed; }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
    }

    main{ padding:18px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .cardhead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .cardhead h2{ font-size:15px; margin:0; }
    .sub{ color:var(--muted); font-size:12px; }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      border-bottom:1px solid #eef0f3;
      padding:8px 6px;
      vertical-align:middle;
      font-size:13px;
    }
    th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      position:sticky;
      top:0;
      background:var(--card);
      z-index:10;
    }

    tr:hover td{ background:#fafafa; }

    /* NEW = blue highlight ONLY in New table */
    #newTable tr.status-new td{ background: rgba(96,165,250,0.18); }

    tr.status-dropped td{ background: rgba(245,158,11,0.16); }
    tr.status-sent td{ background: rgba(22,163,74,0.12); }
    tr.status-cancel td{ background: rgba(239,68,68,0.12); }

    .cell-input, .cell-select{
      width:100%;
      padding:7px 8px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:13px;
      background:#fff;
    }
    .cell-input:focus, .cell-select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,0.12);
    }

    .checkbox{ width:16px; height:16px; }
    .small{ font-size:12px; color:var(--muted); }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .modal{
      width:min(900px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow: var(--shadow);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      box-shadow:none;
      border-bottom:1px solid var(--border);
    }
    .modal .content{ padding:14px; }

    textarea{
      width:100%;
      min-height:220px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      resize:vertical;
      font-size:13px;
    }
    .formgrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    .formgrid .span2{ grid-column: span 2; }
    .formgrid .span6{ grid-column: span 6; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:5px; }

    .toast{
      position:fixed;
      right:14px; bottom:14px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow: var(--shadow);
      display:none;
      max-width:420px;
      font-size:13px;
      z-index:2000;
    }

    .hidden{ display:none !important; }

    /* ====== LOADING OVERLAY (NEW) ====== */
    body.busy{ cursor: wait; }
    .loading-backdrop{
      position:fixed; inset:0;
      background: rgba(17,24,39,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:3000;
    }
    .loading-panel{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:18px 16px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .spinner{
      width:44px; height:44px;
      border-radius:50%;
      border:5px solid #e5e7eb;
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
    .loading-text{ display:flex; flex-direction:column; gap:4px; }
    .loading-title{ font-weight:700; font-size:14px; color:#111827; }
    .loading-sub{ font-size:12px; color: var(--muted); line-height:1.35; }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h1>Inter-Site Stock Transfers</h1>
        <span id="statusPill" class="pill">Ready</span>
      </div>

      <div class="controls">
        <div class="tabs">
          <button class="tab active" id="tabPKY">PKY → DTN</button>
          <button class="tab" id="tabDTN">DTN → PKY</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px;">
          <span class="small">Date</span>
          <input id="datePicker" type="date" class="cell-input" style="width:165px;">
        </div>

        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnAddLine">Add Line</button>
        <button class="btn primary" id="btnPasteUpload">Paste Upload</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">

      <section class="card hidden" id="newCard">
        <div class="cardhead">
          <div>
            <h2>New Transfer Requests</h2>
            <div class="sub">New requests waiting to be accepted by the team managing transfers.</div>
          </div>
          <div class="row-actions">
            <button class="btn primary" id="btnAcceptNew" disabled>Accept Request(s)</button>
            <button class="btn" id="btnPrintNew" disabled>Print</button>
            <button class="btn danger" id="btnCancelNew" disabled>Cancel Request(s)</button>
          </div>
        </div>

        <div style="position:relative; overflow:auto; max-height:320px; border:1px solid #eef0f3; border-radius:12px;">
          <table id="newTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllNew" class="checkbox"></th>
                <th style="width:90px;">TYPE</th>
                <th style="width:160px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:70px;">WH</th>
                <th style="width:90px;">BIN</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="newBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Active Transfers</h2>
            <div class="sub">Accepted requests being worked. Mark Dropped and Sent as items are prepared and despatched.</div>
          </div>
          <div class="row-actions">
            <button class="btn" id="btnPrintActive" disabled>Print</button>
            <button class="btn" id="btnBulkDropped" disabled>Mark Dropped</button>
            <button class="btn" id="btnBulkSent" disabled>Mark Sent</button>
            <button class="btn danger" id="btnCancelActive" disabled>Cancel Request(s)</button>
          </div>
        </div>

        <div style="position:relative; overflow:auto; max-height:520px; border:1px solid #eef0f3; border-radius:12px;">
          <table id="activeTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllActive" class="checkbox"></th>
                <th style="width:90px;">TYPE</th>
                <th style="width:160px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:70px;">WH</th>
                <th style="width:90px;">BIN</th>
                <th style="width:110px;">DROPPED</th>
                <th style="width:90px;">SENT</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="activeBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Sent Transfers</h2>
            <div class="sub">Completed lines for the day (Sent = YES). You can reverse Sent if a line was marked by mistake.</div>
          </div>
          <div class="row-actions">
            <button class="btn" id="btnPrintSent" disabled>Print</button>
            <button class="btn" id="btnReverseSent" disabled>Reverse Sent</button>
            <button class="btn" id="btnToggleSent">Hide</button>
          </div>
        </div>

        <div id="sentWrap" style="position:relative; overflow:auto; max-height:420px; border:1px solid #eef0f3; border-radius:12px;">
          <table id="sentTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllSent" class="checkbox"></th>
                <th style="width:90px;">TYPE</th>
                <th style="width:160px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:70px;">WH</th>
                <th style="width:90px;">BIN</th>
                <th style="width:110px;">DROPPED</th>
                <th style="width:90px;">SENT</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="sentBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card hidden" id="cancelCard">
        <div class="cardhead">
          <div>
            <h2>Cancellations</h2>
            <div class="sub">Cancelled requests for the day. You can reverse a cancellation if needed.</div>
          </div>
          <div class="row-actions">
            <button class="btn" id="btnReverseCancel" disabled>Reverse Cancellation</button>
          </div>
        </div>

        <div style="position:relative; overflow:auto; max-height:320px; border:1px solid #eef0f3; border-radius:12px;">
          <table id="cancelTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllCancel" class="checkbox"></th>
                <th style="width:90px;">TYPE</th>
                <th style="width:160px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:70px;">WH</th>
                <th style="width:90px;">BIN</th>
                <th style="width:110px;">DROPPED</th>
                <th style="width:90px;">SENT</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="cancelBody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <div class="modal-backdrop" id="pasteModal">
    <div class="modal">
      <header>
        <div class="wrap topbar" style="padding:12px 14px;">
          <h1 style="font-size:16px;">Paste Upload</h1>
          <div class="controls">
            <button class="btn" id="btnPasteClose">Close</button>
            <button class="btn primary" id="btnPasteSubmit">Upload</button>
          </div>
        </div>
      </header>
      <div class="content">
        <p class="small" style="margin-top:0;">
          Copy the range from Excel and paste here. Headers are supported (any order). If no headers, assumed columns:
          <strong>PRODUCT, QTY, WH, BIN</strong>. TYPE defaults to BULK for paste uploads. These lines enter as <strong>New</strong>.
        </p>
        <textarea id="pasteBox" placeholder="Paste here..."></textarea>
        <div style="height:1px; background:var(--border); margin:10px 0;"></div>
        <div class="small" id="pastePreview">Nothing pasted yet.</div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="addModal">
    <div class="modal">
      <header>
        <div class="wrap topbar" style="padding:12px 14px;">
          <h1 style="font-size:16px;">Add Line</h1>
          <div class="controls">
            <button class="btn" id="btnAddClose">Close</button>
            <button class="btn primary" id="btnAddSubmit">Add</button>
          </div>
        </div>
      </header>
      <div class="content">
        <div class="formgrid">
          <div class="span2">
            <label>TYPE</label>
            <select id="addType" class="cell-select">
              <option>SPLIT</option>
              <option>BULK</option>
            </select>
          </div>
          <div class="span2">
            <label>PRODUCT</label>
            <input id="addProduct" class="cell-input" placeholder="e.g. 18DR1810A" />
          </div>
          <div class="span2">
            <label>QTY</label>
            <input id="addQty" class="cell-input" type="number" min="0" step="1" placeholder="e.g. 6" />
          </div>
          <div class="span2">
            <label>WH</label>
            <input id="addWH" class="cell-input" placeholder="e.g. BB" />
          </div>
          <div class="span2">
            <label>BIN</label>
            <input id="addBin" class="cell-input" placeholder="e.g. F49E" />
          </div>
          <div class="span6">
            <label>COMMENTS</label>
            <input id="addComments" class="cell-input" placeholder="Optional notes (urgency, order ref, etc.)" />
          </div>
        </div>
        <div class="small" style="margin-top:10px;">
          Note: New lines enter as <strong>New Transfer Requests</strong> until accepted.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ====== LOADING OVERLAY (NEW) ====== -->
  <div class="loading-backdrop" id="loadingOverlay" role="status" aria-live="polite" aria-label="Loading">
    <div class="loading-panel">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-text">
        <div class="loading-title" id="loadingTitle">Working…</div>
        <div class="loading-sub" id="loadingSub">Please wait…</div>
      </div>
    </div>
  </div>

  <script>
    // ====== EDIT THESE ======
    const API_URL = "https://script.google.com/macros/s/AKfycbxpeOikchlafJAHPgZAyGD-5kCbRWijK1jn4zE1uZQOd1LA-DMJIf6ud3INj2HHW9yj/exec";
    const API_KEY = "Lthdn637H7shdbs8987jnsm72GtsFh";

    // ====== SETTINGS ======
    const AUTO_REFRESH_MS = 5 * 60 * 1000;

    // For JSONP GET URLs. Keep safely below typical limits.
    const JSONP_URL_MAX = 1700;

    // ====== STATE ======
    let currentSheet = "PKY_TO_DTN";
    let currentDate = "";
    let rows = [];

    // ====== UI ELEMENTS ======
    const statusPill = document.getElementById("statusPill");

    const tabPKY = document.getElementById("tabPKY");
    const tabDTN = document.getElementById("tabDTN");
    const datePicker = document.getElementById("datePicker");

    const btnRefresh = document.getElementById("btnRefresh");
    const btnPasteUpload = document.getElementById("btnPasteUpload");
    const btnAddLine = document.getElementById("btnAddLine");

    const newCard = document.getElementById("newCard");
    const newBody = document.getElementById("newBody");
    const checkAllNew = document.getElementById("checkAllNew");
    const btnAcceptNew = document.getElementById("btnAcceptNew");
    const btnPrintNew = document.getElementById("btnPrintNew");
    const btnCancelNew = document.getElementById("btnCancelNew");

    const activeBody = document.getElementById("activeBody");
    const checkAllActive = document.getElementById("checkAllActive");
    const btnPrintActive = document.getElementById("btnPrintActive");
    const btnBulkDropped = document.getElementById("btnBulkDropped");
    const btnBulkSent = document.getElementById("btnBulkSent");
    const btnCancelActive = document.getElementById("btnCancelActive");

    const sentWrap = document.getElementById("sentWrap");
    const sentBody = document.getElementById("sentBody");
    const checkAllSent = document.getElementById("checkAllSent");
    const btnPrintSent = document.getElementById("btnPrintSent");
    const btnReverseSent = document.getElementById("btnReverseSent");
    const btnToggleSent = document.getElementById("btnToggleSent");

    const cancelCard = document.getElementById("cancelCard");
    const cancelBody = document.getElementById("cancelBody");
    const checkAllCancel = document.getElementById("checkAllCancel");
    const btnReverseCancel = document.getElementById("btnReverseCancel");

    const pasteModal = document.getElementById("pasteModal");
    const pasteBox = document.getElementById("pasteBox");
    const pastePreview = document.getElementById("pastePreview");
    const btnPasteClose = document.getElementById("btnPasteClose");
    const btnPasteSubmit = document.getElementById("btnPasteSubmit");

    const addModal = document.getElementById("addModal");
    const btnAddClose = document.getElementById("btnAddClose");
    const btnAddSubmit = document.getElementById("btnAddSubmit");
    const addType = document.getElementById("addType");
    const addProduct = document.getElementById("addProduct");
    const addQty = document.getElementById("addQty");
    const addWH = document.getElementById("addWH");
    const addBin = document.getElementById("addBin");
    const addComments = document.getElementById("addComments");

    const toast = document.getElementById("toast");

    // ====== LOADING OVERLAY (NEW) ======
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loadingTitle = document.getElementById("loadingTitle");
    const loadingSub = document.getElementById("loadingSub");
    let __busyCount = 0;

    function isBusy(){ return __busyCount > 0; }

    function showLoading(title="Working…", sub="Please wait…"){
      __busyCount++;
      loadingTitle.textContent = title;
      loadingSub.textContent = sub;

      document.body.classList.add("busy");
      loadingOverlay.style.display = "flex";
    }

    function hideLoading(){
      __busyCount = Math.max(0, __busyCount - 1);
      if (__busyCount === 0){
        loadingOverlay.style.display = "none";
        document.body.classList.remove("busy");
      }
    }

    async function withLoading(title, fn, sub){
      showLoading(title, sub || "Please wait…");
      try{
        return await fn();
      } finally {
        hideLoading();
      }
    }

    // ====== HELPERS ======
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function setStatus(text, kind=""){
      statusPill.textContent = text;
      statusPill.style.borderColor = "";
      statusPill.style.color = "";
      statusPill.style.background = "#fff";

      if (kind === "ok"){
        statusPill.style.borderColor = "rgba(22,163,74,0.4)";
        statusPill.style.color = "#166534";
        statusPill.style.background = "rgba(22,163,74,0.08)";
      }
      if (kind === "warn"){
        statusPill.style.borderColor = "rgba(245,158,11,0.5)";
        statusPill.style.color = "#92400e";
        statusPill.style.background = "rgba(245,158,11,0.10)";
      }
      if (kind === "err"){
        statusPill.style.borderColor = "rgba(239,68,68,0.5)";
        statusPill.style.color = "#991b1b";
        statusPill.style.background = "rgba(239,68,68,0.10)";
      }
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => toast.style.display = "none", 3000);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== JSONP ======
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(16).slice(2);
        const u = new URL(url);
        u.searchParams.set("callback", cb);

        const script = document.createElement("script");
        script.src = u.toString();
        script.async = true;

        let done = false;

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 20000);

        window[cb] = (data) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          reject(new Error("Failed to fetch (JSONP)"));
        };

        function cleanup(){
          try { delete window[cb]; } catch(e){}
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        document.body.appendChild(script);
      });
    }

    function buildApiUrl(action, payload = {}){
      const url = new URL(API_URL);
      url.searchParams.set("action", action);
      url.searchParams.set("sheet", currentSheet);
      url.searchParams.set("date", currentDate);
      url.searchParams.set("apiKey", API_KEY);

      if (action === "add") {
        const row = payload.row || {};
        url.searchParams.set("DATE", row.DATE || currentDate || todayISO());
        url.searchParams.set("TYPE", row.TYPE || "SPLIT");
        url.searchParams.set("PRODUCT", row.PRODUCT || "");
        url.searchParams.set("QTY", (row.QTY === "" || row.QTY == null) ? "" : String(row.QTY));
        url.searchParams.set("WH", row.WH || "");
        url.searchParams.set("BIN", row.BIN || "");
        url.searchParams.set("DROPPED", row.DROPPED || "");
        url.searchParams.set("SENT", row.SENT || "");
        url.searchParams.set("COMMENTS", row.COMMENTS || "");
        url.searchParams.set("STATUS", row.STATUS || "NEW");
      }

      if (action === "bulkAdd") url.searchParams.set("rows", JSON.stringify(payload.rows || []));
      if (action === "update") {
        url.searchParams.set("rowId", String(payload.rowId || ""));
        url.searchParams.set("patch", JSON.stringify(payload.patch || {}));
      }
      if (action === "bulkUpdate") {
        url.searchParams.set("rowIds", JSON.stringify(payload.rowIds || []));
        url.searchParams.set("patch", JSON.stringify(payload.patch || {}));
      }

      return url.toString();
    }

    async function apiCall(action, payload = {}){
      return await jsonp(buildApiUrl(action, payload));
    }

    // ✅ Robust bulk upload: automatically chunks so URL doesn’t exceed JSONP limits
    async function bulkAddChunked(allRows){
      let addedTotal = 0;
      let i = 0;

      while (i < allRows.length){
        const chunk = [];
        while (i < allRows.length){
          chunk.push(allRows[i]);
          const testUrl = buildApiUrl("bulkAdd", { rows: chunk });
          if (testUrl.length > JSONP_URL_MAX){
            chunk.pop();
            break;
          }
          i++;
        }

        if (chunk.length === 0){
          throw new Error("One line is too large to upload via JSONP. Shorten COMMENTS or upload fewer columns.");
        }

        const res = await apiCall("bulkAdd", { rows: chunk });
        if (!res.ok) throw new Error(res.error || "Upload failed");
        addedTotal += (res.added || chunk.length);
      }

      return addedTotal;
    }

    // ====== SELECTION ======
    function selectedRowIds(selector){
      return [...document.querySelectorAll(selector)]
        .filter(x => x.checked)
        .map(x => Number(x.getAttribute("data-rowid")));
    }
    function selectedRowsByIds(ids){
      const set = new Set(ids);
      return rows.filter(r => set.has(Number(r.rowId)));
    }

    function updateButtons(){
      const newIds = selectedRowIds("input[data-rowcheck='new']:checked");
      btnAcceptNew.disabled = newIds.length === 0;
      btnPrintNew.disabled = newIds.length === 0;
      btnCancelNew.disabled = newIds.length === 0;

      const activeIds = selectedRowIds("input[data-rowcheck='active']:checked");
      btnPrintActive.disabled = activeIds.length === 0;
      btnBulkDropped.disabled = activeIds.length === 0;
      btnBulkSent.disabled = activeIds.length === 0;
      btnCancelActive.disabled = activeIds.length === 0;

      const sentIds = selectedRowIds("input[data-rowcheck='sent']:checked");
      btnPrintSent.disabled = sentIds.length === 0;
      btnReverseSent.disabled = sentIds.length === 0;

      const cancelIds = selectedRowIds("input[data-rowcheck='cancel']:checked");
      btnReverseCancel.disabled = cancelIds.length === 0;
    }

    // ====== PRINTING ======
    function printLines(title, lines){
      const w = window.open("", "_blank");
      const safeTitle = escapeHtml(title);
      const dateTxt = escapeHtml(currentDate);
      const dirTxt = escapeHtml(currentSheet);

      const rowsHtml = lines.map(r => `
        <tr>
          <td>${escapeHtml((r.TYPE||"").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      const closeScript = "</scr" + "ipt>";

      w.document.write(`
        <html>
        <head>
          <title>${safeTitle}</title>
          <meta charset="utf-8">
          <style>
            body{ font-family: Arial, sans-serif; padding:16px; }
            h1{ margin:0 0 6px 0; font-size:18px; }
            .meta{ margin:0 0 12px 0; color:#555; font-size:12px; }
            table{ width:100%; border-collapse:collapse; }
            th, td{ border:1px solid #ddd; padding:8px; font-size:12px; text-align:left; }
            th{ background:#f3f4f6; }
          </style>
        </head>
        <body>
          <h1>${safeTitle}</h1>
          <p class="meta">Date: ${dateTxt} • Direction: ${dirTxt}</p>
          <table>
            <thead>
              <tr>
                <th>TYPE</th><th>PRODUCT</th><th>QTY</th><th>WH</th><th>BIN</th><th>COMMENTS</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
          <script>
            window.onload = function(){ window.print(); };
          ${closeScript}
        </body>
        </html>
      `);

      w.document.close();
    }

    // ====== RENDERING ======
    function rowClass(r){
      const status = (r.STATUS || "").toString().trim().toUpperCase();
      const sent = (r.SENT || "").toString().trim().toUpperCase() === "YES";
      const dropped = (r.DROPPED || "").toString().trim().toUpperCase() === "YES";

      if (status === "NEW") return "status-new";
      if (status === "CANCELLED") return "status-cancel";
      if (sent) return "status-sent";
      if (dropped) return "status-dropped";
      return "";
    }

    function buildSelect(options, value){
      const v = (value ?? "").toString();
      return `<select class="cell-select">
        ${options.map(o => `<option value="${escapeHtml(o)}" ${o===v ? "selected":""}>${escapeHtml(o)}</option>`).join("")}
      </select>`;
    }

    function buildInput(value, type="text"){
      return `<input class="cell-input" type="${type}" value="${escapeHtml(value ?? "")}">`;
    }

    function render(){
      const status = (x) => (x.STATUS || "").toString().trim().toUpperCase();
      const isSent = (x) => (x.SENT || "").toString().trim().toUpperCase() === "YES";

      const newReq = rows.filter(r => !isSent(r) && status(r) === "NEW");
      const active = rows.filter(r => !isSent(r) && status(r) === "ACTIVE");
      const sent = rows.filter(r => isSent(r) && status(r) !== "CANCELLED");
      const cancelled = rows.filter(r => status(r) === "CANCELLED");

      newCard.classList.toggle("hidden", newReq.length === 0);
      cancelCard.classList.toggle("hidden", cancelled.length === 0);

      newBody.innerHTML = newReq.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="new" data-rowid="${r.rowId}"></td>
          <td>${escapeHtml((r.TYPE || "").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      activeBody.innerHTML = active.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="active" data-rowid="${r.rowId}"></td>
          <td data-col="TYPE">${buildSelect(["SPLIT","BULK"], (r.TYPE || "SPLIT").toString().toUpperCase())}</td>
          <td data-col="PRODUCT">${buildInput(r.PRODUCT)}</td>
          <td data-col="QTY">${buildInput(r.QTY, "number")}</td>
          <td data-col="WH">${buildInput(r.WH)}</td>
          <td data-col="BIN">${buildInput(r.BIN)}</td>
          <td data-col="DROPPED">${buildSelect(["","YES"], (r.DROPPED || "").toString().toUpperCase())}</td>
          <td data-col="SENT">${buildSelect(["","YES"], (r.SENT || "").toString().toUpperCase())}</td>
          <td data-col="COMMENTS">${buildInput(r.COMMENTS)}</td>
        </tr>
      `).join("");

      sentBody.innerHTML = sent.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="sent" data-rowid="${r.rowId}"></td>
          <td>${escapeHtml((r.TYPE || "").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml((r.DROPPED || "").toUpperCase())}</td>
          <td>${escapeHtml((r.SENT || "").toUpperCase())}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      cancelBody.innerHTML = cancelled.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="cancel" data-rowid="${r.rowId}"></td>
          <td>${escapeHtml((r.TYPE || "").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml((r.DROPPED || "").toUpperCase())}</td>
          <td>${escapeHtml((r.SENT || "").toUpperCase())}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      checkAllNew.checked = false;
      checkAllActive.checked = false;
      checkAllSent.checked = false;
      checkAllCancel.checked = false;

      updateButtons();
      setStatus(`Loaded ${rows.length} lines`, "ok");
    }

    async function refresh(showOverlay = true){
      if (showOverlay && isBusy()) return; // prevents double-refresh spam while already busy
      const doWork = async () => {
        try {
          setStatus("Loading…", "warn");
          const data = await apiCall("list");
          if (!data.ok) throw new Error(data.error || "API error");
          rows = data.rows || [];
          render();
        } catch (e) {
          setStatus("Error loading", "err");
          showToast(String(e.message || e));
        }
      };

      if (showOverlay){
        await withLoading("Loading transfers…", doWork, "Fetching the latest lines…");
      } else {
        await doWork();
      }
    }

    async function patchRow(rowId, patch){
      const res = await apiCall("update", { rowId, patch });
      if (!res.ok) throw new Error(res.error || "Update failed");
    }

    async function bulkPatch(rowIds, patch){
      const res = await apiCall("bulkUpdate", { rowIds, patch });
      if (!res.ok) throw new Error(res.error || "Bulk update failed");
    }

    // ====== INPUT NORMALISATION ======
    document.addEventListener("input", (ev) => {
      const input = ev.target;
      if (!input.classList.contains("cell-input")) return;

      const td = input.closest("td[data-col]");
      if (!td) return;

      const col = td.getAttribute("data-col");
      if (["PRODUCT","WH","BIN","COMMENTS"].includes(col)) {
        const pos = input.selectionStart;
        input.value = input.value.toUpperCase();
        try { input.setSelectionRange(pos, pos); } catch(e){}
      }
    });

    // ====== EVENTS ======
    tabPKY.addEventListener("click", () => {
      if (isBusy()) return;
      currentSheet = "PKY_TO_DTN";
      tabPKY.classList.add("active");
      tabDTN.classList.remove("active");
      refresh(true);
    });
    tabDTN.addEventListener("click", () => {
      if (isBusy()) return;
      currentSheet = "DTN_TO_PKY";
      tabDTN.classList.add("active");
      tabPKY.classList.remove("active");
      refresh(true);
    });

    btnRefresh.addEventListener("click", () => refresh(true));

    datePicker.addEventListener("change", () => {
      if (isBusy()) return;
      currentDate = datePicker.value || todayISO();
      refresh(true);
    });

    function setAll(which, checked){
      if (isBusy()) return;
      document.querySelectorAll(`input[data-rowcheck='${which}']`).forEach(c => c.checked = checked);
      updateButtons();
    }
    checkAllNew.addEventListener("change", () => setAll("new", checkAllNew.checked));
    checkAllActive.addEventListener("change", () => setAll("active", checkAllActive.checked));
    checkAllSent.addEventListener("change", () => setAll("sent", checkAllSent.checked));
    checkAllCancel.addEventListener("change", () => setAll("cancel", checkAllCancel.checked));

    document.addEventListener("change", (ev) => {
      if (ev.target && ev.target.matches("input[type='checkbox'][data-rowcheck]")) updateButtons();
    });

    document.addEventListener("change", async (ev) => {
      if (isBusy()) return;

      const tr = ev.target.closest("tr[data-rowid]");
      if (!tr) return;

      const td = ev.target.closest("td[data-col]");
      if (!td) return;

      const rowId = Number(tr.getAttribute("data-rowid"));
      const col = td.getAttribute("data-col");

      let value = (ev.target.tagName === "SELECT") ? ev.target.value : ev.target.value;

      if (col === "TYPE") value = (value || "SPLIT").toUpperCase();
      if (col === "DROPPED") value = (value || "").toUpperCase();
      if (col === "SENT") value = (value || "").toUpperCase();

      if (col === "PRODUCT" || col === "WH" || col === "BIN") value = (value || "").toString().trim().toUpperCase();
      if (col === "COMMENTS") value = (value || "").toString().toUpperCase();
      if (col === "QTY") value = value === "" ? "" : Number(value);

      if (col === "PRODUCT" && value === "") { showToast("Product cannot be blank"); await refresh(true); return; }
      if (col === "WH" && value === "") { showToast("WH cannot be blank"); await refresh(true); return; }
      if (col === "BIN" && value === "") { showToast("BIN cannot be blank"); await refresh(true); return; }

      await withLoading("Saving changes…", async () => {
        try{
          setStatus("Saving…", "warn");
          await patchRow(rowId, { [col]: value });
          showToast("Saved");
          await refresh(false);
        } catch(e){
          setStatus("Save failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating and refreshing the page…");
    });

    // ====== NEW ACTIONS ======
    btnAcceptNew.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='new']:checked");
      if (!ids.length) return;

      await withLoading("Accepting request(s)…", async () => {
        try{
          setStatus("Accepting…", "warn");
          await bulkPatch(ids, { STATUS: "ACTIVE" });
          showToast("Accepted");
          await refresh(false);
        } catch(e){
          setStatus("Accept failed", "err");
          showToast(String(e.message || e));
        }
      }, "Moving selected lines to Active Transfers…");
    });

    btnPrintNew.addEventListener("click", () => {
      const ids = selectedRowIds("input[data-rowcheck='new']:checked");
      if (!ids.length) return;
      printLines("New Transfer Requests", selectedRowsByIds(ids));
    });

    btnCancelNew.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='new']:checked");
      if (!ids.length) return;
      if (!confirm("Cancel the selected request(s)?")) return;

      await withLoading("Cancelling request(s)…", async () => {
        try{
          setStatus("Cancelling…", "warn");
          await bulkPatch(ids, { STATUS: "CANCELLED" });
          showToast("Cancelled");
          await refresh(false);
        } catch(e){
          setStatus("Cancel failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating and refreshing the page…");
    });

    // ====== ACTIVE ACTIONS ======
    btnPrintActive.addEventListener("click", () => {
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;
      printLines("Active Transfers", selectedRowsByIds(ids));
    });

    btnBulkDropped.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;

      await withLoading("Marking Dropped…", async () => {
        try{
          setStatus("Saving…", "warn");
          await bulkPatch(ids, { DROPPED: "YES" });
          showToast("Marked Dropped");
          await refresh(false);
        } catch(e){
          setStatus("Bulk save failed", "err");
          showToast(String(e.message || e));
        }
      }, "Setting DROPPED = YES for selected lines…");
    });

    btnBulkSent.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;

      await withLoading("Marking Sent…", async () => {
        try{
          setStatus("Saving…", "warn");
          await bulkPatch(ids, { SENT: "YES" });
          showToast("Marked Sent");
          await refresh(false);
        } catch(e){
          setStatus("Bulk save failed", "err");
          showToast(String(e.message || e));
        }
      }, "Setting SENT = YES for selected lines…");
    });

    btnCancelActive.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;
      if (!confirm("Cancel the selected active transfer(s)?")) return;

      await withLoading("Cancelling transfer(s)…", async () => {
        try{
          setStatus("Cancelling…", "warn");
          await bulkPatch(ids, { STATUS: "CANCELLED" });
          showToast("Cancelled");
          await refresh(false);
        } catch(e){
          setStatus("Cancel failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating and refreshing the page…");
    });

    // ====== SENT ACTIONS ======
    btnPrintSent.addEventListener("click", () => {
      const ids = selectedRowIds("input[data-rowcheck='sent']:checked");
      if (!ids.length) return;
      printLines("Sent Transfers", selectedRowsByIds(ids));
    });

    btnReverseSent.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='sent']:checked");
      if (!ids.length) return;
      if (!confirm("Reverse 'Sent' for the selected line(s)? They will return to Active Transfers.")) return;

      await withLoading("Reversing Sent…", async () => {
        try{
          setStatus("Reversing…", "warn");
          await bulkPatch(ids, { SENT: "", STATUS: "ACTIVE" });
          showToast("Reversed Sent");
          await refresh(false);
        } catch(e){
          setStatus("Reverse failed", "err");
          showToast(String(e.message || e));
        }
      }, "Moving selected lines back to Active Transfers…");
    });

    btnToggleSent.addEventListener("click", () => {
      const hidden = sentWrap.style.display === "none";
      sentWrap.style.display = hidden ? "block" : "none";
      btnToggleSent.textContent = hidden ? "Hide" : "Show";
    });

    // ====== CANCELLED ACTIONS ======
    btnReverseCancel.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='cancel']:checked");
      if (!ids.length) return;
      if (!confirm("Reverse cancellation for the selected line(s)? They will return to Active Transfers.")) return;

      await withLoading("Reversing cancellation…", async () => {
        try{
          setStatus("Reversing…", "warn");
          await bulkPatch(ids, { STATUS: "ACTIVE" });
          showToast("Reversed Cancellation");
          await refresh(false);
        } catch(e){
          setStatus("Reverse failed", "err");
          showToast(String(e.message || e));
        }
      }, "Returning selected lines to Active Transfers…");
    });

    // ====== PASTE UPLOAD ======
    btnPasteUpload.addEventListener("click", () => {
      if (isBusy()) return;
      pasteBox.value = "";
      pastePreview.textContent = "Nothing pasted yet.";
      pasteModal.style.display = "flex";
      pasteBox.focus();
    });
    btnPasteClose.addEventListener("click", () => pasteModal.style.display = "none");

    function normaliseHeader(h){
      return String(h || "").trim().toUpperCase().replaceAll(" ", "_").replaceAll("-", "_");
    }

    function parsePaste(text){
      const t = (text || "").trim();
      if (!t) return { rows: [], preview: "Nothing pasted yet." };

      const lines = t.split(/\r?\n/).filter(x => x.trim() !== "");
      const grid = lines.map(line => line.split("\t"));

      const first = grid[0].map(normaliseHeader);
      const headerLike =
        first.includes("PRODUCT") || first.includes("PRODUCT_CODE") ||
        first.includes("QTY") || first.includes("WH") ||
        first.includes("BIN") || first.includes("TYPE");

      let headers = [];
      let startRow = 0;

      if (headerLike) { headers = first; startRow = 1; }
      else { headers = ["PRODUCT","QTY","WH","BIN"]; startRow = 0; }

      const mapKey = (h) => {
        if (h === "PRODUCT_CODE" || h === "PRODUCTCODE") return "PRODUCT";
        if (h === "PRODUCT") return "PRODUCT";
        if (h === "QTY" || h === "QUANTITY") return "QTY";
        if (h === "WH" || h === "WAREHOUSE") return "WH";
        if (h === "BIN") return "BIN";
        if (h === "TYPE") return "TYPE";
        if (h === "COMMENTS" || h === "COMMENT") return "COMMENTS";
        return h;
      };

      const keys = headers.map(mapKey);

      const out = [];
      for (let r = startRow; r < grid.length; r++){
        const row = grid[r];
        const obj = {
          DATE: currentDate || todayISO(),
          TYPE: "BULK",
          PRODUCT: "",
          QTY: "",
          WH: "",
          BIN: "",
          DROPPED: "",
          SENT: "",
          COMMENTS: "",
          STATUS: "NEW"
        };

        for (let c = 0; c < row.length; c++){
          const k = keys[c] || "";
          const vRaw = (row[c] ?? "").toString();
          const v = vRaw.trim();
          if (!k) continue;

          if (k === "TYPE") obj.TYPE = (v || "BULK").toUpperCase();
          else if (k === "QTY") obj.QTY = v === "" ? "" : Number(v);
          else if (k === "PRODUCT") obj.PRODUCT = v.toUpperCase();
          else if (k === "WH") obj.WH = v.toUpperCase();
          else if (k === "BIN") obj.BIN = v.toUpperCase();
          else if (k === "COMMENTS") obj.COMMENTS = vRaw.toUpperCase();
        }

        if (!headerLike && row.length >= 1) obj.PRODUCT = (row[0] ?? "").toString().trim().toUpperCase();
        if (!headerLike && row.length >= 2) obj.QTY = (row[1] ?? "").toString().trim() === "" ? "" : Number(row[1]);
        if (!headerLike && row.length >= 3) obj.WH = (row[2] ?? "").toString().trim().toUpperCase();
        if (!headerLike && row.length >= 4) obj.BIN = (row[3] ?? "").toString().trim().toUpperCase();

        if (obj.PRODUCT && obj.WH && obj.BIN) out.push(obj);
      }

      const preview = `Parsed ${out.length} line(s). First line: ` +
        (out[0] ? `${out[0].TYPE} ${out[0].PRODUCT} x${out[0].QTY} (${out[0].WH}/${out[0].BIN})` : "n/a");

      return { rows: out, preview };
    }

    pasteBox.addEventListener("input", () => {
      const parsed = parsePaste(pasteBox.value);
      pastePreview.textContent = parsed.preview;
    });

    btnPasteSubmit.addEventListener("click", async () => {
      if (isBusy()) return;
      const parsed = parsePaste(pasteBox.value);
      if (!parsed.rows.length){
        showToast("Nothing valid to upload (requires PRODUCT, WH, BIN)");
        return;
      }

      await withLoading("Uploading lines…", async () => {
        try{
          setStatus("Uploading…", "warn");
          // ✅ chunked upload to avoid JSONP URL length failures
          const added = await bulkAddChunked(parsed.rows);
          showToast(`Uploaded ${added} lines`);
          pasteModal.style.display = "none";
          await refresh(false);
        } catch(e){
          setStatus("Upload failed", "err");
          showToast(String(e.message || e));
        }
      }, "Saving pasted lines and refreshing…");
    });

    // ====== ADD LINE ======
    btnAddLine.addEventListener("click", () => {
      if (isBusy()) return;
      addType.value = "SPLIT";
      addProduct.value = "";
      addQty.value = "";
      addWH.value = "";
      addBin.value = "";
      addComments.value = "";
      addModal.style.display = "flex";
      addProduct.focus();
    });
    btnAddClose.addEventListener("click", () => addModal.style.display = "none");

    btnAddSubmit.addEventListener("click", async () => {
      if (isBusy()) return;

      const row = {
        DATE: currentDate || todayISO(),
        TYPE: (addType.value || "SPLIT").toUpperCase(),
        PRODUCT: (addProduct.value || "").trim().toUpperCase(),
        QTY: addQty.value === "" ? "" : Number(addQty.value),
        WH: (addWH.value || "").trim().toUpperCase(),
        BIN: (addBin.value || "").trim().toUpperCase(),
        DROPPED: "",
        SENT: "",
        COMMENTS: (addComments.value || "").toString().toUpperCase(),
        STATUS: "NEW"
      };

      if (!row.PRODUCT){ showToast("Product is required"); return; }
      if (!row.WH){ showToast("WH is required"); return; }
      if (!row.BIN){ showToast("BIN is required"); return; }

      await withLoading("Adding line…", async () => {
        try{
          setStatus("Adding…", "warn");
          const res = await apiCall("add", { row });
          if (!res.ok) throw new Error(res.error || "Add failed");
          showToast("Added to New Requests");
          addModal.style.display = "none";
          await refresh(false);
        } catch(e){
          setStatus("Add failed", "err");
          showToast(String(e.message || e));
        }
      }, "Saving the new line and refreshing…");
    });

    // ====== AUTO REFRESH ======
    setInterval(() => {
      if (isBusy()) return;
      currentDate = todayISO();
      datePicker.value = currentDate;
      refresh(true);
    }, AUTO_REFRESH_MS);

    // ====== START ======
    (function(){
      currentDate = todayISO();
      datePicker.value = currentDate;
      refresh(true);
    })();
  </script>
</body>
</html>
