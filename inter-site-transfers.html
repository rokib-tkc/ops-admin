<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inter-Site Stock Transfers</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#d1d5db;

      --accent:#2563eb;
      --ok:#16a34a;
      --warn:#f59e0b;

      --sent:#16a34a;
      --dropped:#f59e0b;
      --cancel:#ef4444;

      --priority:#b91c1c;        /* dark red */
      --priorityBg: rgba(185,28,28,0.12); /* light red highlight */

      --shadow: 0 6px 16px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    *{ box-sizing:border-box; font-family: Arial, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    header{
      background:var(--card);
      box-shadow:var(--shadow);
      padding:14px 18px;
      position:sticky; top:0; z-index:20;
    }
    .wrap{ max-width:1200px; margin:0 auto; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ font-size:18px; margin:0; }

    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .tabs{ display:flex; gap:8px; }

    /* ===== Tabs (polished) ===== */
    .tab{
      border:1px solid var(--accent);
      background:#fff;
      padding:8px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      color: var(--accent);
      transition: all 0.15s ease;
      position: relative;
    }
    .tab:not(.active):hover{
      background: rgba(37,99,235,0.08);
      transform: translateY(-1px);
    }
    .tab:active{
      transform: translateY(0px) scale(0.98);
    }
    .tab.active{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 4px 10px rgba(37,99,235,0.35);
      transform: translateY(-1px);
    }
    .tab.active:hover{
      transform: translateY(-1px);
    }

    /* ===== Buttons ===== */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: all 0.15s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(0.98); }

    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.danger{
      background:var(--cancel);
      border-color:var(--cancel);
      color:#fff;
    }
    .btn.priority{
      background: var(--priority);
      border-color: var(--priority);
      color:#fff;
    }
    .btn.priority:hover{ filter: brightness(0.95); }

    .btn:disabled{ opacity:0.55; cursor:not-allowed; transform:none; }

    /* Home button */
    .btn.home{
      border-color: rgba(37,99,235,0.25);
      background: rgba(37,99,235,0.06);
      color: #1d4ed8;
    }
    .btn.home:hover{
      background: rgba(37,99,235,0.10);
    }

    /* Yellow Refresh button */
    #btnRefresh{
      background: #facc15;
      border-color: #facc15;
      color: #111827;
    }
    #btnRefresh:hover{ filter: brightness(0.95); }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
    }

    main{ padding:18px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .cardhead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .cardhead h2{ font-size:15px; margin:0; }
    .sub{ color:var(--muted); font-size:12px; }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      border-bottom:1px solid #eef0f3;
      padding:8px 6px;
      vertical-align:middle;
      font-size:13px;
    }
    th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      position:sticky;
      top:0;
      background:var(--card);
      z-index:10;
    }

    tr:hover td{ background:#fafafa; }

    /* New = blue highlight (unless priority / dropped / sent) */
    #newTable tr.status-new td{ background: rgba(96,165,250,0.18); }

    tr.status-dropped td{ background: rgba(245,158,11,0.16); }
    tr.status-sent td{ background: rgba(22,163,74,0.12); }
    tr.status-cancel td{ background: rgba(239,68,68,0.12); }

    /* Priority highlight (applies only when NOT dropped/sent/cancelled) */
    tr.status-priority td{ background: var(--priorityBg) !important; }

    .prio-flag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px; height:18px;
      border-radius:999px;
      background: rgba(185,28,28,0.12);
      border: 1px solid rgba(185,28,28,0.35);
      color: var(--priority);
      font-weight:900;
      font-size:12px;
      line-height:1;
    }
    .prio-flag.empty{
      background: transparent;
      border-color: transparent;
      color: transparent;
    }

    .cell-input, .cell-select{
      width:100%;
      padding:7px 8px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:13px;
      background:#fff;
    }
    .cell-input:focus, .cell-select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,0.12);
    }

    /* ===== TYPE colouring in Active table ===== */
    .type-split{
      background: rgba(250, 204, 21, 0.35) !important; /* yellow */
    }

    .type-bulk{
      background: rgba(239, 68, 68, 0.25) !important; /* light red */
    }


    .checkbox{ width:16px; height:16px; }
    .small{ font-size:12px; color:var(--muted); }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .modal{
      width:min(1050px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow: var(--shadow);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      box-shadow:none;
      border-bottom:1px solid var(--border);
    }
    .modal .content{ padding:14px; }

    textarea{
      width:100%;
      min-height:220px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      resize:vertical;
      font-size:13px;
    }

    .toast{
      position:fixed;
      right:14px; bottom:14px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow: var(--shadow);
      display:none;
      max-width:420px;
      font-size:13px;
      z-index:2000;
    }

    .hidden{ display:none !important; }

    /* ====== LOADING OVERLAY ====== */
    body.busy{ cursor: wait; }
    .loading-backdrop{
      position:fixed; inset:0;
      background: rgba(17,24,39,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:3000;
    }
    .loading-panel{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:18px 16px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .spinner{
      width:44px; height:44px;
      border-radius:50%;
      border:5px solid #e5e7eb;
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
    .loading-text{ display:flex; flex-direction:column; gap:4px; }
    .loading-title{ font-weight:700; font-size:14px; color:#111827; }
    .loading-sub{ font-size:12px; color: var(--muted); line-height:1.35; }

    /* ===== Add Lines (multi-row) UI ===== */
    .addlines-wrap{
      border:1px solid #eef0f3;
      border-radius:12px;
      overflow:auto;
      max-height:420px;
    }
    .addlines-table{
      width:100%;
      border-collapse:collapse;
      min-width: 980px; /* keeps table-like feel */
    }
    .addlines-table th, .addlines-table td{
      border-bottom:1px solid #eef0f3;
      padding:10px 8px;
      vertical-align:top;
      font-size:13px;
      background:#fff;
    }
    .addlines-table th{
      position:sticky;
      top:0;
      z-index:2;
      background:#fff;
      color: var(--muted);
      font-size:12px;
      text-align:left;
    }
    .iconbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: all 0.15s ease;
      white-space:nowrap;
    }
    .iconbtn:hover{ transform: translateY(-1px); }
    .iconbtn:active{ transform: translateY(0px) scale(0.98); }
    .iconbtn.danger{
      border-color: rgba(239,68,68,0.45);
      background: rgba(239,68,68,0.08);
      color:#991b1b;
    }
    .hint{
      margin:10px 0 0 0;
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h1>Inter-Site Stock Transfers</h1>
        <span id="statusPill" class="pill">Ready</span>
      </div>

      <div class="controls">
        <button class="btn home" id="btnHome" title="Back to Ops Admin Home">Home</button>

        <div class="tabs">
          <button class="tab active" id="tabPKY">PKY → DTN</button>
          <button class="tab" id="tabDTN">DTN → PKY</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px;">
          <span class="small">Date</span>
          <input id="datePicker" type="date" class="cell-input" style="width:165px;">
        </div>

        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnAddLine">Add Line</button>
        <button class="btn" id="btnPasteUpload">Paste Upload</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">

      <section class="card hidden" id="newCard">
        <div class="cardhead">
          <div>
            <h2>New Transfer Requests</h2>
            <div class="sub">New requests waiting to be accepted by the team managing transfers.</div>
          </div>
          <div class="row-actions">
            <button class="btn priority" id="btnPriorityNew" disabled>Priority</button>
            <button class="btn primary" id="btnAcceptNew" disabled>Accept Request(s)</button>
            <button class="btn" id="btnPrintNew" disabled>Print</button>
            <button class="btn danger" id="btnCancelNew" disabled>Cancel Request(s)</button>
          </div>
        </div>

        <div style="position:relative; border:1px solid #eef0f3; border-radius:12px;">
          <table id="newTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllNew" class="checkbox"></th>
                <th style="width:30px;"></th>
                <th style="width:100px;">TYPE</th>
                <th style="width:170px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:60px;">WH</th>
                <th style="width:80px;">BIN</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="newBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Active Transfers</h2>
            <div class="sub">Accepted requests being worked. Mark Dropped and Sent as items are prepared and despatched.</div>
          </div>
          <div class="row-actions">
            <button class="btn priority" id="btnPriorityActive" disabled>Priority</button>
            <button class="btn" id="btnPrintActive" disabled>Print</button>
            <button class="btn" id="btnBulkDropped" disabled>Mark Dropped</button>
            <button class="btn" id="btnBulkSent" disabled>Mark Sent</button>
            <button class="btn danger" id="btnCancelActive" disabled>Cancel Request(s)</button>
          </div>
        </div>

        <div style="position:relative; border:1px solid #eef0f3; border-radius:12px;">
          <table id="activeTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllActive" class="checkbox"></th>
                <th style="width:30px;"></th>
                <th style="width:100px;">TYPE</th>
                <th style="width:170px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:60px;">WH</th>
                <th style="width:80px;">BIN</th>
                <th style="width:80px;">DROPPED</th>
                <th style="width:80px;">SENT</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="activeBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Sent Transfers</h2>
            <div class="sub">Completed lines for the day (Sent = YES). You can reverse Sent if a line was marked by mistake.</div>
          </div>
          <div class="row-actions">
            <button class="btn" id="btnPrintSent" disabled>Print</button>
            <button class="btn" id="btnReverseSent" disabled>Reverse Sent</button>
            <button class="btn" id="btnToggleSent">Hide</button>
          </div>
        </div>

        <div id="sentWrap" style="position:relative; border:1px solid #eef0f3; border-radius:12px;">
          <table id="sentTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllSent" class="checkbox"></th>
                <th style="width:30px;"></th>
                <th style="width:100px;">TYPE</th>
                <th style="width:170px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:60px;">WH</th>
                <th style="width:80px;">BIN</th>
                <th style="width:80px;">DROPPED</th>
                <th style="width:80px;">SENT</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="sentBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card hidden" id="cancelCard">
        <div class="cardhead">
          <div>
            <h2>Cancellations</h2>
            <div class="sub">Cancelled requests for the day. You can reverse a cancellation if needed.</div>
          </div>
          <div class="row-actions">
            <button class="btn" id="btnReverseCancel" disabled>Reverse Cancellation</button>
          </div>
        </div>

        <div style="position:relative; border:1px solid #eef0f3; border-radius:12px;">
          <table id="cancelTable">
            <thead>
              <tr>
                <th style="width:34px;"><input type="checkbox" id="checkAllCancel" class="checkbox"></th>
                <th style="width:30px;"></th>
                <th style="width:100px;">TYPE</th>
                <th style="width:170px;">PRODUCT</th>
                <th style="width:80px;">QTY</th>
                <th style="width:60px;">WH</th>
                <th style="width:80px;">BIN</th>
                <th style="width:80px;">DROPPED</th>
                <th style="width:80px;">SENT</th>
                <th>COMMENTS</th>
              </tr>
            </thead>
            <tbody id="cancelBody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <!-- Paste Modal (unchanged behaviour) -->
  <div class="modal-backdrop" id="pasteModal">
    <div class="modal">
      <header>
        <div class="wrap topbar" style="padding:12px 14px;">
          <h1 style="font-size:16px;">Paste Upload</h1>
          <div class="controls">
            <button class="btn" id="btnPasteClose">Close</button>
            <button class="btn primary" id="btnPasteSubmit">Upload</button>
          </div>
        </div>
      </header>
      <div class="content">
        <p class="small" style="margin-top:0;">
          Copy the range from Excel and paste here. Headers are supported (any order). If no headers, assumed columns:
          <strong>PRODUCT, QTY, WH, BIN</strong>. TYPE defaults to BULK for paste uploads. These lines enter as <strong>New</strong>.
        </p>
        <textarea id="pasteBox" placeholder="Paste here..."></textarea>
        <div style="height:1px; background:var(--border); margin:10px 0;"></div>
        <div class="small" id="pastePreview">Nothing pasted yet.</div>
      </div>
    </div>
  </div>

  <!-- Add Lines Modal (NEW multi-line) -->
  <div class="modal-backdrop" id="addModal">
    <div class="modal">
      <header>
        <div class="wrap topbar" style="padding:12px 14px;">
          <h1 style="font-size:16px;">Add Line(s)</h1>
          <div class="controls">
            <button class="btn" id="btnAddClose">Close</button>
            <button class="btn primary" id="btnAddSubmit">Add</button>
          </div>
        </div>
      </header>
      <div class="content">

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <div class="small">Add one or more lines. <strong>PRODUCT is required</strong>. WH/BIN can be left blank.</div>
          <button class="btn" id="btnAddAnother">+ Add another line</button>
        </div>

        <div class="addlines-wrap">
          <table class="addlines-table">
            <thead>
              <tr>
                <th style="width:120px;">TYPE</th>
                <th style="width:200px;">PRODUCT</th>
                <th style="width:110px;">QTY</th>
                <th style="width:110px;">WH</th>
                <th style="width:120px;">BIN</th>
                <th>COMMENTS</th>
                <th style="width:120px;">ACTION</th>
              </tr>
            </thead>
            <tbody id="addLinesBody"></tbody>
          </table>
        </div>

        <p class="hint">
          Notes:
          <br>• Lines are created as <strong>NEW</strong> and non-priority by default.
          <br>• You can mark Priority afterwards from <strong>New</strong> or <strong>Active</strong>.
        </p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="loading-backdrop" id="loadingOverlay" role="status" aria-live="polite" aria-label="Loading">
    <div class="loading-panel">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-text">
        <div class="loading-title" id="loadingTitle">Working…</div>
        <div class="loading-sub" id="loadingSub">Please wait…</div>
      </div>
    </div>
  </div>

  <script>
    // ====== EDIT THESE ======
    const API_URL = "https://script.google.com/macros/s/AKfycbxpeOikchlafJAHPgZAyGD-5kCbRWijK1jn4zE1uZQOd1LA-DMJIf6ud3INj2HHW9yj/exec";
    const API_KEY = "Lthdn637H7shdbs8987jnsm72GtsFh";

    // Home URL - points back to Ops Admin home
    const HOME_URL = "index.html";

    // ====== SETTINGS ======
    const AUTO_REFRESH_MS = 5 * 60 * 1000;
    const JSONP_URL_MAX = 1700;

    // ====== STATE ======
    let currentSheet = "PKY_TO_DTN";
    let currentDate = "";
    let rows = [];

    // ====== UI ELEMENTS ======
    const statusPill = document.getElementById("statusPill");

    const tabPKY = document.getElementById("tabPKY");
    const tabDTN = document.getElementById("tabDTN");
    const datePicker = document.getElementById("datePicker");

    const btnHome = document.getElementById("btnHome");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnPasteUpload = document.getElementById("btnPasteUpload");
    const btnAddLine = document.getElementById("btnAddLine");

    const newCard = document.getElementById("newCard");
    const newBody = document.getElementById("newBody");
    const checkAllNew = document.getElementById("checkAllNew");
    const btnPriorityNew = document.getElementById("btnPriorityNew");
    const btnAcceptNew = document.getElementById("btnAcceptNew");
    const btnPrintNew = document.getElementById("btnPrintNew");
    const btnCancelNew = document.getElementById("btnCancelNew");

    const activeBody = document.getElementById("activeBody");
    const checkAllActive = document.getElementById("checkAllActive");
    const btnPriorityActive = document.getElementById("btnPriorityActive");
    const btnPrintActive = document.getElementById("btnPrintActive");
    const btnBulkDropped = document.getElementById("btnBulkDropped");
    const btnBulkSent = document.getElementById("btnBulkSent");
    const btnCancelActive = document.getElementById("btnCancelActive");

    const sentWrap = document.getElementById("sentWrap");
    const sentBody = document.getElementById("sentBody");
    const checkAllSent = document.getElementById("checkAllSent");
    const btnPrintSent = document.getElementById("btnPrintSent");
    const btnReverseSent = document.getElementById("btnReverseSent");
    const btnToggleSent = document.getElementById("btnToggleSent");

    const cancelCard = document.getElementById("cancelCard");
    const cancelBody = document.getElementById("cancelBody");
    const checkAllCancel = document.getElementById("checkAllCancel");
    const btnReverseCancel = document.getElementById("btnReverseCancel");

    const pasteModal = document.getElementById("pasteModal");
    const pasteBox = document.getElementById("pasteBox");
    const pastePreview = document.getElementById("pastePreview");
    const btnPasteClose = document.getElementById("btnPasteClose");
    const btnPasteSubmit = document.getElementById("btnPasteSubmit");

    const addModal = document.getElementById("addModal");
    const btnAddClose = document.getElementById("btnAddClose");
    const btnAddSubmit = document.getElementById("btnAddSubmit");
    const btnAddAnother = document.getElementById("btnAddAnother");
    const addLinesBody = document.getElementById("addLinesBody");

    const toast = document.getElementById("toast");

    // ====== LOADING OVERLAY ======
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loadingTitle = document.getElementById("loadingTitle");
    const loadingSub = document.getElementById("loadingSub");
    let __busyCount = 0;

    function isBusy(){ return __busyCount > 0; }

    function showLoading(title="Working…", sub="Please wait…"){
      __busyCount++;
      loadingTitle.textContent = title;
      loadingSub.textContent = sub;
      document.body.classList.add("busy");
      loadingOverlay.style.display = "flex";
    }

    function hideLoading(){
      __busyCount = Math.max(0, __busyCount - 1);
      if (__busyCount === 0){
        loadingOverlay.style.display = "none";
        document.body.classList.remove("busy");
      }
    }

    async function withLoading(title, fn, sub){
      showLoading(title, sub || "Please wait…");
      try{
        return await fn();
      } finally {
        hideLoading();
      }
    }

    // ====== HELPERS ======
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function setStatus(text, kind=""){
      statusPill.textContent = text;
      statusPill.style.borderColor = "";
      statusPill.style.color = "";
      statusPill.style.background = "#fff";

      if (kind === "ok"){
        statusPill.style.borderColor = "rgba(22,163,74,0.4)";
        statusPill.style.color = "#166534";
        statusPill.style.background = "rgba(22,163,74,0.08)";
      }
      if (kind === "warn"){
        statusPill.style.borderColor = "rgba(245,158,11,0.5)";
        statusPill.style.color = "#92400e";
        statusPill.style.background = "rgba(245,158,11,0.10)";
      }
      if (kind === "err"){
        statusPill.style.borderColor = "rgba(239,68,68,0.5)";
        statusPill.style.color = "#991b1b";
        statusPill.style.background = "rgba(239,68,68,0.10)";
      }
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => toast.style.display = "none", 3000);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== TYPE COLOUR HELPER =====
    function applyTypeColour(selectEl){
      if (!selectEl) return;

    // Remove any previous type classes
      selectEl.classList.remove("type-split", "type-bulk");

      const v = (selectEl.value || "").toUpperCase();

      if (v === "SPLIT") selectEl.classList.add("type-split");
      else if (v === "BULK") selectEl.classList.add("type-bulk");
      // ORDER = no colour
    }


    function isYes(v){
      return (v || "").toString().trim().toUpperCase() === "YES";
    }

    // ====== JSONP ======
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(16).slice(2);
        const u = new URL(url);
        u.searchParams.set("callback", cb);

        const script = document.createElement("script");
        script.src = u.toString();
        script.async = true;

        let done = false;

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 20000);

        window[cb] = (data) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          reject(new Error("Failed to fetch (JSONP)"));
        };

        function cleanup(){
          try { delete window[cb]; } catch(e){}
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        document.body.appendChild(script);
      });
    }

    function buildApiUrl(action, payload = {}){
      const url = new URL(API_URL);
      url.searchParams.set("action", action);
      url.searchParams.set("sheet", currentSheet);
      url.searchParams.set("date", currentDate);
      url.searchParams.set("apiKey", API_KEY);

      if (action === "add") {
        const row = payload.row || {};
        url.searchParams.set("DATE", row.DATE || currentDate || todayISO());
        url.searchParams.set("TYPE", row.TYPE || "SPLIT");
        url.searchParams.set("PRODUCT", row.PRODUCT || "");
        url.searchParams.set("QTY", (row.QTY === "" || row.QTY == null) ? "" : String(row.QTY));
        url.searchParams.set("WH", row.WH || "");
        url.searchParams.set("BIN", row.BIN || "");
        url.searchParams.set("DROPPED", row.DROPPED || "");
        url.searchParams.set("SENT", row.SENT || "");
        url.searchParams.set("COMMENTS", row.COMMENTS || "");
        url.searchParams.set("STATUS", row.STATUS || "NEW");
        // NEW COLUMN in sheet:
        url.searchParams.set("PRIORITY", row.PRIORITY || "");
      }

      if (action === "bulkAdd") url.searchParams.set("rows", JSON.stringify(payload.rows || []));
      if (action === "update") {
        url.searchParams.set("rowId", String(payload.rowId || ""));
        url.searchParams.set("patch", JSON.stringify(payload.patch || {}));
      }
      if (action === "bulkUpdate") {
        url.searchParams.set("rowIds", JSON.stringify(payload.rowIds || []));
        url.searchParams.set("patch", JSON.stringify(payload.patch || {}));
      }

      return url.toString();
    }

    async function apiCall(action, payload = {}){
      return await jsonp(buildApiUrl(action, payload));
    }

    // Robust bulk upload: automatically chunks so URL doesn’t exceed JSONP limits
    async function bulkAddChunked(allRows){
      let addedTotal = 0;
      let i = 0;

      while (i < allRows.length){
        const chunk = [];
        while (i < allRows.length){
          chunk.push(allRows[i]);
          const testUrl = buildApiUrl("bulkAdd", { rows: chunk });
          if (testUrl.length > JSONP_URL_MAX){
            chunk.pop();
            break;
          }
          i++;
        }

        if (chunk.length === 0){
          throw new Error("One line is too large to upload via JSONP. Shorten COMMENTS or upload fewer columns.");
        }

        const res = await apiCall("bulkAdd", { rows: chunk });
        if (!res.ok) throw new Error(res.error || "Upload failed");
        addedTotal += (res.added || chunk.length);
      }

      return addedTotal;
    }

    // ====== SELECTION ======
    function selectedRowIds(selector){
      return [...document.querySelectorAll(selector)]
        .filter(x => x.checked)
        .map(x => Number(x.getAttribute("data-rowid")));
    }
    function selectedRowsByIds(ids){
      const set = new Set(ids);
      return rows.filter(r => set.has(Number(r.rowId)));
    }

    function updatePriorityButton(btn, selectedIds){
      if (!selectedIds.length){
        btn.disabled = true;
        btn.textContent = "Priority";
        return;
      }
      btn.disabled = false;
      const selected = selectedRowsByIds(selectedIds);
      const allPriority = selected.length > 0 && selected.every(r => isYes(r.PRIORITY));
      btn.textContent = allPriority ? "Unmark Priority" : "Priority";
    }

    function updateButtons(){
      const newIds = selectedRowIds("input[data-rowcheck='new']:checked");
      btnAcceptNew.disabled = newIds.length === 0;
      btnPrintNew.disabled = newIds.length === 0;
      btnCancelNew.disabled = newIds.length === 0;
      updatePriorityButton(btnPriorityNew, newIds);

      const activeIds = selectedRowIds("input[data-rowcheck='active']:checked");
      btnPrintActive.disabled = activeIds.length === 0;
      btnBulkDropped.disabled = activeIds.length === 0;
      btnBulkSent.disabled = activeIds.length === 0;
      btnCancelActive.disabled = activeIds.length === 0;
      updatePriorityButton(btnPriorityActive, activeIds);

      const sentIds = selectedRowIds("input[data-rowcheck='sent']:checked");
      btnPrintSent.disabled = sentIds.length === 0;
      btnReverseSent.disabled = sentIds.length === 0;

      const cancelIds = selectedRowIds("input[data-rowcheck='cancel']:checked");
      btnReverseCancel.disabled = cancelIds.length === 0;
    }

    // ====== PRINTING ======
    function printLines(title, lines){
      const w = window.open("", "_blank");
      const safeTitle = escapeHtml(title);
      const dateTxt = escapeHtml(currentDate);
      const dirTxt = escapeHtml(currentSheet);

      const rowsHtml = lines.map(r => `
        <tr>
          <td>${escapeHtml((r.TYPE||"").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      const closeScript = "</scr" + "ipt>";

      w.document.write(`
        <html>
        <head>
          <title>${safeTitle}</title>
          <meta charset="utf-8">
          <style>
            body{ font-family: Arial, sans-serif; padding:16px; }
            h1{ margin:0 0 6px 0; font-size:18px; }
            .meta{ margin:0 0 12px 0; color:#555; font-size:12px; }
            table{ width:100%; border-collapse:collapse; }
            th, td{ border:1px solid #ddd; padding:8px; font-size:12px; text-align:left; }
            th{ background:#f3f4f6; }
          </style>
        </head>
        <body>
          <h1>${safeTitle}</h1>
          <p class="meta">Date: ${dateTxt} • Direction: ${dirTxt}</p>
          <table>
            <thead>
              <tr>
                <th>TYPE</th><th>PRODUCT</th><th>QTY</th><th>WH</th><th>BIN</th><th>COMMENTS</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
          <script>
            window.onload = function(){ window.print(); };
          ${closeScript}
        </body>
        </html>
      `);

      w.document.close();
    }

    // ====== RENDERING ======
    function rowClass(r){
      const status = (r.STATUS || "").toString().trim().toUpperCase();
      const sent = isYes(r.SENT);
      const dropped = isYes(r.DROPPED);
      const priority = isYes(r.PRIORITY);

      if (status === "CANCELLED") return "status-cancel";
      if (sent) return "status-sent";
      if (dropped) return "status-dropped";

      // Priority highlight remains until Dropped/Sent/Cancelled (handled above)
      if (priority) return "status-priority";

      if (status === "NEW") return "status-new";
      return "";
    }

    function buildSelect(options, value){
      const v = (value ?? "").toString();
      return `<select class="cell-select">
        ${options.map(o => `<option value="${escapeHtml(o)}" ${o===v ? "selected":""}>${escapeHtml(o)}</option>`).join("")}
      </select>`;
    }

    function buildInput(value, type="text"){
      return `<input class="cell-input" type="${type}" value="${escapeHtml(value ?? "")}">`;
    }

    function buildPrioFlag(priorityYes){
      if (priorityYes){
        return `<span class="prio-flag" title="Priority">!</span>`;
      }
      return `<span class="prio-flag empty">!</span>`;
    }

    function sortPriorityFirst(list){
      // Priority YES first, then stable by rowId ascending
      return [...list].sort((a,b) => {
        const ap = isYes(a.PRIORITY) ? 1 : 0;
        const bp = isYes(b.PRIORITY) ? 1 : 0;
        if (ap !== bp) return bp - ap;
        return Number(a.rowId) - Number(b.rowId);
      });
    }

    function render(){
      const status = (x) => (x.STATUS || "").toString().trim().toUpperCase();
      const isSentRow = (x) => isYes(x.SENT);

      const newReq = sortPriorityFirst(rows.filter(r => !isSentRow(r) && status(r) === "NEW"));
      const active = sortPriorityFirst(rows.filter(r => !isSentRow(r) && status(r) === "ACTIVE"));
      const sent = sortPriorityFirst(rows.filter(r => isSentRow(r) && status(r) !== "CANCELLED"));
      const cancelled = sortPriorityFirst(rows.filter(r => status(r) === "CANCELLED"));

      newCard.classList.toggle("hidden", newReq.length === 0);
      cancelCard.classList.toggle("hidden", cancelled.length === 0);

      newBody.innerHTML = newReq.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="new" data-rowid="${r.rowId}"></td>
          <td>${buildPrioFlag(isYes(r.PRIORITY))}</td>
          <td>${escapeHtml((r.TYPE || "").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      activeBody.innerHTML = active.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="active" data-rowid="${r.rowId}"></td>
          <td>${buildPrioFlag(isYes(r.PRIORITY))}</td>
          <td data-col="TYPE">${buildSelect(["SPLIT","BULK","ORDER"], (r.TYPE || "SPLIT").toString().toUpperCase())}</td>
          <td data-col="PRODUCT">${buildInput(r.PRODUCT)}</td>
          <td data-col="QTY">${buildInput(r.QTY, "number")}</td>
          <td data-col="WH">${buildInput(r.WH)}</td>
          <td data-col="BIN">${buildInput(r.BIN)}</td>
          <td data-col="DROPPED">${buildSelect(["","YES"], (r.DROPPED || "").toString().toUpperCase())}</td>
          <td data-col="SENT">${buildSelect(["","YES"], (r.SENT || "").toString().toUpperCase())}</td>
          <td data-col="COMMENTS">${buildInput(r.COMMENTS)}</td>
        </tr>
      `).join("");


      // Apply TYPE colouring to Active table
    activeBody.querySelectorAll("td[data-col='TYPE'] select").forEach(sel => {
      applyTypeColour(sel);
    });


      sentBody.innerHTML = sent.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="sent" data-rowid="${r.rowId}"></td>
          <td>${buildPrioFlag(isYes(r.PRIORITY))}</td>
          <td>${escapeHtml((r.TYPE || "").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml((r.DROPPED || "").toUpperCase())}</td>
          <td>${escapeHtml((r.SENT || "").toUpperCase())}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      cancelBody.innerHTML = cancelled.map(r => `
        <tr class="${rowClass(r)}" data-rowid="${r.rowId}">
          <td><input class="checkbox" type="checkbox" data-rowcheck="cancel" data-rowid="${r.rowId}"></td>
          <td>${buildPrioFlag(isYes(r.PRIORITY))}</td>
          <td>${escapeHtml((r.TYPE || "").toUpperCase())}</td>
          <td>${escapeHtml(r.PRODUCT)}</td>
          <td>${escapeHtml(r.QTY)}</td>
          <td>${escapeHtml(r.WH)}</td>
          <td>${escapeHtml(r.BIN)}</td>
          <td>${escapeHtml((r.DROPPED || "").toUpperCase())}</td>
          <td>${escapeHtml((r.SENT || "").toUpperCase())}</td>
          <td>${escapeHtml(r.COMMENTS)}</td>
        </tr>
      `).join("");

      checkAllNew.checked = false;
      checkAllActive.checked = false;
      checkAllSent.checked = false;
      checkAllCancel.checked = false;

      updateButtons();
      setStatus(`Loaded ${rows.length} lines`, "ok");
    }

    async function refresh(showOverlay = true){
      if (showOverlay && isBusy()) return;
      const doWork = async () => {
        try {
          setStatus("Loading…", "warn");
          const data = await apiCall("list");
          if (!data.ok) throw new Error(data.error || "API error");
          rows = data.rows || [];
          render();
        } catch (e) {
          setStatus("Error loading", "err");
          showToast(String(e.message || e));
        }
      };

      if (showOverlay){
        await withLoading("Loading transfers…", doWork, "Fetching the latest lines…");
      } else {
        await doWork();
      }
    }

    async function patchRow(rowId, patch){
      const res = await apiCall("update", { rowId, patch });
      if (!res.ok) throw new Error(res.error || "Update failed");
    }

    async function bulkPatch(rowIds, patch){
      const res = await apiCall("bulkUpdate", { rowIds, patch });
      if (!res.ok) throw new Error(res.error || "Bulk update failed");
    }

    // ====== INPUT NORMALISATION ======
    document.addEventListener("input", (ev) => {
      const input = ev.target;
      if (!input.classList.contains("cell-input")) return;

      const td = input.closest("td[data-col]");
      if (!td) return;

      const col = td.getAttribute("data-col");
      if (["PRODUCT","WH","BIN","COMMENTS"].includes(col)) {
        const pos = input.selectionStart;
        input.value = input.value.toUpperCase();
        try { input.setSelectionRange(pos, pos); } catch(e){}
      }
    });

    // ====== HOME BUTTON ======
    btnHome.addEventListener("click", () => {
      if (isBusy()){
        showToast("Please wait for the current action to finish.");
        return;
      }
      if (pasteModal.style.display === "flex" || addModal.style.display === "flex"){
        if (!confirm("Close this window and return to Home?")) return;
      }
      window.location.href = HOME_URL;
    });

    // ====== EVENTS ======
    tabPKY.addEventListener("click", () => {
      if (isBusy()) return;
      currentSheet = "PKY_TO_DTN";
      tabPKY.classList.add("active");
      tabDTN.classList.remove("active");
      refresh(true);
    });
    tabDTN.addEventListener("click", () => {
      if (isBusy()) return;
      currentSheet = "DTN_TO_PKY";
      tabDTN.classList.add("active");
      tabPKY.classList.remove("active");
      refresh(true);
    });

    btnRefresh.addEventListener("click", () => refresh(true));

    datePicker.addEventListener("change", () => {
      if (isBusy()) return;
      currentDate = datePicker.value || todayISO();
      refresh(true);
    });

    function setAll(which, checked){
      if (isBusy()) return;
      document.querySelectorAll(`input[data-rowcheck='${which}']`).forEach(c => c.checked = checked);
      updateButtons();
    }
    checkAllNew.addEventListener("change", () => setAll("new", checkAllNew.checked));
    checkAllActive.addEventListener("change", () => setAll("active", checkAllActive.checked));
    checkAllSent.addEventListener("change", () => setAll("sent", checkAllSent.checked));
    checkAllCancel.addEventListener("change", () => setAll("cancel", checkAllCancel.checked));

    document.addEventListener("change", (ev) => {
      if (ev.target && ev.target.matches("input[type='checkbox'][data-rowcheck]")) updateButtons();
    });

    // Inline edit changes (Active Transfers)
    document.addEventListener("change", async (ev) => {
      if (isBusy()) return;

      const tr = ev.target.closest("tr[data-rowid]");
      if (!tr) return;

      const td = ev.target.closest("td[data-col]");
      if (!td) return;

      const rowId = Number(tr.getAttribute("data-rowid"));
      const col = td.getAttribute("data-col");

      let value = (ev.target.tagName === "SELECT") ? ev.target.value : ev.target.value;

      if (col === "TYPE") value = (value || "SPLIT").toUpperCase();

      // Update colour immediately in UI when TYPE changes
    if (col === "TYPE" && ev.target.tagName === "SELECT"){
      applyTypeColour(ev.target);
    }

      if (col === "DROPPED") value = (value || "").toUpperCase();
      if (col === "SENT") value = (value || "").toUpperCase();

      if (col === "PRODUCT" || col === "WH" || col === "BIN") value = (value || "").toString().trim().toUpperCase();
      if (col === "COMMENTS") value = (value || "").toString().toUpperCase();
      if (col === "QTY") value = value === "" ? "" : Number(value);

      // PRODUCT still required, but WH/BIN now allowed to be blank
      if (col === "PRODUCT" && value === "") { showToast("Product cannot be blank"); await refresh(true); return; }

      await withLoading("Saving changes…", async () => {
        try{
          setStatus("Saving…", "warn");
          await patchRow(rowId, { [col]: value });
          showToast("Saved");
          await refresh(false);
        } catch(e){
          setStatus("Save failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating and refreshing the page…");
    });

    // ====== PRIORITY ACTIONS ======
    async function togglePriorityForSelected(which){
      const ids = selectedRowIds(`input[data-rowcheck='${which}']:checked`);
      if (!ids.length) return;

      const selected = selectedRowsByIds(ids);
      const allPriority = selected.length > 0 && selected.every(r => isYes(r.PRIORITY));
      const newValue = allPriority ? "" : "YES";

      await withLoading(allPriority ? "Removing Priority…" : "Setting Priority…", async () => {
        try{
          setStatus("Saving…", "warn");
          await bulkPatch(ids, { PRIORITY: newValue });
          showToast(allPriority ? "Priority removed" : "Marked as Priority");
          await refresh(false);
        } catch(e){
          setStatus("Priority update failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating selected lines…");
    }

    btnPriorityNew.addEventListener("click", async () => {
      if (isBusy()) return;
      await togglePriorityForSelected("new");
    });

    btnPriorityActive.addEventListener("click", async () => {
      if (isBusy()) return;
      await togglePriorityForSelected("active");
    });

    // ====== NEW ACTIONS ======
    btnAcceptNew.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='new']:checked");
      if (!ids.length) return;

      await withLoading("Accepting request(s)…", async () => {
        try{
          setStatus("Accepting…", "warn");
          await bulkPatch(ids, { STATUS: "ACTIVE" });
          showToast("Accepted");
          await refresh(false);
        } catch(e){
          setStatus("Accept failed", "err");
          showToast(String(e.message || e));
        }
      }, "Moving selected lines to Active Transfers…");
    });

    btnPrintNew.addEventListener("click", () => {
      const ids = selectedRowIds("input[data-rowcheck='new']:checked");
      if (!ids.length) return;
      printLines("New Transfer Requests", selectedRowsByIds(ids));
    });

    btnCancelNew.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='new']:checked");
      if (!ids.length) return;
      if (!confirm("Cancel the selected request(s)?")) return;

      await withLoading("Cancelling request(s)…", async () => {
        try{
          setStatus("Cancelling…", "warn");
          await bulkPatch(ids, { STATUS: "CANCELLED" });
          showToast("Cancelled");
          await refresh(false);
        } catch(e){
          setStatus("Cancel failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating and refreshing the page…");
    });

    // ====== ACTIVE ACTIONS ======
    btnPrintActive.addEventListener("click", () => {
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;
      printLines("Active Transfers", selectedRowsByIds(ids));
    });

    btnBulkDropped.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;

      await withLoading("Marking Dropped…", async () => {
        try{
          setStatus("Saving…", "warn");
          await bulkPatch(ids, { DROPPED: "YES" });
          showToast("Marked Dropped");
          await refresh(false);
        } catch(e){
          setStatus("Bulk save failed", "err");
          showToast(String(e.message || e));
        }
      }, "Setting DROPPED = YES for selected lines…");
    });

    btnBulkSent.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;

      await withLoading("Marking Sent…", async () => {
        try{
          setStatus("Saving…", "warn");
          await bulkPatch(ids, { SENT: "YES" });
          showToast("Marked Sent");
          await refresh(false);
        } catch(e){
          setStatus("Bulk save failed", "err");
          showToast(String(e.message || e));
        }
      }, "Setting SENT = YES for selected lines…");
    });

    btnCancelActive.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='active']:checked");
      if (!ids.length) return;
      if (!confirm("Cancel the selected active transfer(s)?")) return;

      await withLoading("Cancelling transfer(s)…", async () => {
        try{
          setStatus("Cancelling…", "warn");
          await bulkPatch(ids, { STATUS: "CANCELLED" });
          showToast("Cancelled");
          await refresh(false);
        } catch(e){
          setStatus("Cancel failed", "err");
          showToast(String(e.message || e));
        }
      }, "Updating and refreshing the page…");
    });

    // ====== SENT ACTIONS ======
    btnPrintSent.addEventListener("click", () => {
      const ids = selectedRowIds("input[data-rowcheck='sent']:checked");
      if (!ids.length) return;
      printLines("Sent Transfers", selectedRowsByIds(ids));
    });

    btnReverseSent.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='sent']:checked");
      if (!ids.length) return;
      if (!confirm("Reverse 'Sent' for the selected line(s)? They will return to Active Transfers.")) return;

      await withLoading("Reversing Sent…", async () => {
        try{
          setStatus("Reversing…", "warn");
          await bulkPatch(ids, { SENT: "", STATUS: "ACTIVE" });
          showToast("Reversed Sent");
          await refresh(false);
        } catch(e){
          setStatus("Reverse failed", "err");
          showToast(String(e.message || e));
        }
      }, "Moving selected lines back to Active Transfers…");
    });

    btnToggleSent.addEventListener("click", () => {
      const hidden = sentWrap.style.display === "none";
      sentWrap.style.display = hidden ? "block" : "none";
      btnToggleSent.textContent = hidden ? "Hide" : "Show";
    });

    // ====== CANCELLED ACTIONS ======
    btnReverseCancel.addEventListener("click", async () => {
      if (isBusy()) return;
      const ids = selectedRowIds("input[data-rowcheck='cancel']:checked");
      if (!ids.length) return;
      if (!confirm("Reverse cancellation for the selected line(s)? They will return to Active Transfers.")) return;

      await withLoading("Reversing cancellation…", async () => {
        try{
          setStatus("Reversing…", "warn");
          await bulkPatch(ids, { STATUS: "ACTIVE" });
          showToast("Reversed Cancellation");
          await refresh(false);
        } catch(e){
          setStatus("Reverse failed", "err");
          showToast(String(e.message || e));
        }
      }, "Returning selected lines to Active Transfers…");
    });

    // ====== PASTE UPLOAD (unchanged rules: requires PRODUCT, WH, BIN) ======
    btnPasteUpload.addEventListener("click", () => {
      if (isBusy()) return;
      pasteBox.value = "";
      pastePreview.textContent = "Nothing pasted yet.";
      pasteModal.style.display = "flex";
      pasteBox.focus();
    });
    btnPasteClose.addEventListener("click", () => pasteModal.style.display = "none");

    function normaliseHeader(h){
      return String(h || "").trim().toUpperCase().replaceAll(" ", "_").replaceAll("-", "_");
    }

    function parsePaste(text){
      const t = (text || "").trim();
      if (!t) return { rows: [], preview: "Nothing pasted yet." };

      const lines = t.split(/\r?\n/).filter(x => x.trim() !== "");
      const grid = lines.map(line => line.split("\t"));

      const first = grid[0].map(normaliseHeader);
      const headerLike =
        first.includes("PRODUCT") || first.includes("PRODUCT_CODE") ||
        first.includes("QTY") || first.includes("WH") ||
        first.includes("BIN") || first.includes("TYPE");

      let headers = [];
      let startRow = 0;

      if (headerLike) { headers = first; startRow = 1; }
      else { headers = ["PRODUCT","QTY","WH","BIN"]; startRow = 0; }

      const mapKey = (h) => {
        if (h === "PRODUCT_CODE" || h === "PRODUCTCODE") return "PRODUCT";
        if (h === "PRODUCT") return "PRODUCT";
        if (h === "QTY" || h === "QUANTITY") return "QTY";
        if (h === "WH" || h === "WAREHOUSE") return "WH";
        if (h === "BIN") return "BIN";
        if (h === "TYPE") return "TYPE";
        if (h === "COMMENTS" || h === "COMMENT") return "COMMENTS";
        return h;
      };

      const keys = headers.map(mapKey);

      const out = [];
      for (let r = startRow; r < grid.length; r++){
        const row = grid[r];
        const obj = {
          DATE: currentDate || todayISO(),
          TYPE: "BULK",
          PRODUCT: "",
          QTY: "",
          WH: "",
          BIN: "",
          DROPPED: "",
          SENT: "",
          COMMENTS: "",
          STATUS: "NEW",
          PRIORITY: "" // new column
        };

        for (let c = 0; c < row.length; c++){
          const k = keys[c] || "";
          const vRaw = (row[c] ?? "").toString();
          const v = vRaw.trim();
          if (!k) continue;

          if (k === "TYPE") obj.TYPE = (v || "BULK").toUpperCase();
          else if (k === "QTY") obj.QTY = v === "" ? "" : Number(v);
          else if (k === "PRODUCT") obj.PRODUCT = v.toUpperCase();
          else if (k === "WH") obj.WH = v.toUpperCase();
          else if (k === "BIN") obj.BIN = v.toUpperCase();
          else if (k === "COMMENTS") obj.COMMENTS = vRaw.toUpperCase();
        }

        if (!headerLike && row.length >= 1) obj.PRODUCT = (row[0] ?? "").toString().trim().toUpperCase();
        if (!headerLike && row.length >= 2) obj.QTY = (row[1] ?? "").toString().trim() === "" ? "" : Number(row[1]);
        if (!headerLike && row.length >= 3) obj.WH = (row[2] ?? "").toString().trim().toUpperCase();
        if (!headerLike && row.length >= 4) obj.BIN = (row[3] ?? "").toString().trim().toUpperCase();

        // Keep existing rule: paste uploads require PRODUCT + WH + BIN
        if (obj.PRODUCT && obj.WH && obj.BIN) out.push(obj);
      }

      const preview = `Parsed ${out.length} line(s). First line: ` +
        (out[0] ? `${out[0].TYPE} ${out[0].PRODUCT} x${out[0].QTY} (${out[0].WH}/${out[0].BIN})` : "n/a");

      return { rows: out, preview };
    }

    pasteBox.addEventListener("input", () => {
      const parsed = parsePaste(pasteBox.value);
      pastePreview.textContent = parsed.preview;
    });

    btnPasteSubmit.addEventListener("click", async () => {
      if (isBusy()) return;
      const parsed = parsePaste(pasteBox.value);
      if (!parsed.rows.length){
        showToast("Nothing valid to upload (requires PRODUCT, WH, BIN)");
        return;
      }

      await withLoading("Uploading lines…", async () => {
        try{
          setStatus("Uploading…", "warn");
          const added = await bulkAddChunked(parsed.rows);
          showToast(`Uploaded ${added} lines`);
          pasteModal.style.display = "none";
          await refresh(false);
        } catch(e){
          setStatus("Upload failed", "err");
          showToast(String(e.message || e));
        }
      }, "Saving pasted lines and refreshing…");
    });

    // ====== ADD LINES (multi-row) ======
    function makeAddRow(prefillType){
      const type = (prefillType || "SPLIT").toUpperCase();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <select class="cell-select" data-addcol="TYPE">
            <option ${type==="SPLIT" ? "selected":""}>SPLIT</option>
            <option ${type==="BULK" ? "selected":""}>BULK</option>
            <option ${type==="ORDER" ? "selected":""}>ORDER</option>
          </select>
        </td>
        <td><input class="cell-input" data-addcol="PRODUCT" placeholder="e.g. 18DR1810A" /></td>
        <td><input class="cell-input" data-addcol="QTY" type="number" min="0" step="1" placeholder="e.g. 6" /></td>
        <td><input class="cell-input" data-addcol="WH" placeholder="e.g. BB" /></td>
        <td><input class="cell-input" data-addcol="BIN" placeholder="e.g. F49E" /></td>
        <td><input class="cell-input" data-addcol="COMMENTS" placeholder="Optional notes (urgency, order ref, etc.)" /></td>
        <td><button class="iconbtn danger" data-action="remove">Remove</button></td>
      `;
      return tr;
    }

    function resetAddModal(){
      addLinesBody.innerHTML = "";
      addLinesBody.appendChild(makeAddRow("SPLIT"));
      // focus first product
      const firstProduct = addLinesBody.querySelector("input[data-addcol='PRODUCT']");
      if (firstProduct) firstProduct.focus();
    }

    btnAddLine.addEventListener("click", () => {
      if (isBusy()) return;
      resetAddModal();
      addModal.style.display = "flex";
    });

    btnAddClose.addEventListener("click", () => addModal.style.display = "none");

    btnAddAnother.addEventListener("click", () => {
      if (isBusy()) return;
      // default new row uses the last row's TYPE if available
      const lastTypeSel = addLinesBody.querySelector("tr:last-child select[data-addcol='TYPE']");
      const nextType = lastTypeSel ? lastTypeSel.value : "SPLIT";
      addLinesBody.appendChild(makeAddRow(nextType));
      const newRowProduct = addLinesBody.querySelector("tr:last-child input[data-addcol='PRODUCT']");
      if (newRowProduct) newRowProduct.focus();
    });

    addLinesBody.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button[data-action='remove']");
      if (!btn) return;
      const tr = btn.closest("tr");
      if (!tr) return;

      // Keep at least one row visible
      if (addLinesBody.querySelectorAll("tr").length <= 1){
        showToast("At least one line is required.");
        return;
      }
      tr.remove();
    });

    // Uppercase while typing in Add modal (PRODUCT/WH/BIN/COMMENTS)
    addLinesBody.addEventListener("input", (ev) => {
      const el = ev.target;
      if (!el || !el.matches("input.cell-input")) return;
      const col = el.getAttribute("data-addcol");
      if (!["PRODUCT","WH","BIN","COMMENTS"].includes(col)) return;

      const pos = el.selectionStart;
      el.value = (el.value || "").toUpperCase();
      try { el.setSelectionRange(pos, pos); } catch(e){}
    });

    function readAddModalRows(){
      const trs = [...addLinesBody.querySelectorAll("tr")];
      const out = [];

      for (const tr of trs){
        const get = (col) => {
          const el = tr.querySelector(`[data-addcol='${col}']`);
          return el ? el.value : "";
        };

        const row = {
          DATE: currentDate || todayISO(),
          TYPE: (get("TYPE") || "SPLIT").toString().trim().toUpperCase(),
          PRODUCT: (get("PRODUCT") || "").toString().trim().toUpperCase(),
          QTY: get("QTY") === "" ? "" : Number(get("QTY")),
          WH: (get("WH") || "").toString().trim().toUpperCase(),
          BIN: (get("BIN") || "").toString().trim().toUpperCase(),
          DROPPED: "",
          SENT: "",
          COMMENTS: (get("COMMENTS") || "").toString().toUpperCase(),
          STATUS: "NEW",
          PRIORITY: ""
        };

        // Only PRODUCT is forced
        if (!row.PRODUCT){
          return { ok:false, error:"Product is required on all lines." };
        }

        // TYPE safeguard
        if (!["SPLIT","BULK","ORDER"].includes(row.TYPE)) row.TYPE = "SPLIT";

        out.push(row);
      }

      return { ok:true, rows: out };
    }

    btnAddSubmit.addEventListener("click", async () => {
      if (isBusy()) return;

      const parsed = readAddModalRows();
      if (!parsed.ok){
        showToast(parsed.error || "Check your lines.");
        return;
      }

      await withLoading("Adding line(s)…", async () => {
        try{
          setStatus("Adding…", "warn");
          const added = await bulkAddChunked(parsed.rows);
          showToast(`Added ${added} line(s) to New Requests`);
          addModal.style.display = "none";
          await refresh(false);
        } catch(e){
          setStatus("Add failed", "err");
          showToast(String(e.message || e));
        }
      }, "Saving the new line(s) and refreshing…");
    });

    // ====== AUTO REFRESH ======
    setInterval(() => {
      if (isBusy()) return;
      currentDate = todayISO();
      datePicker.value = currentDate;
      refresh(false);
    }, AUTO_REFRESH_MS);

    // ====== START ======
    (function(){
      currentDate = todayISO();
      datePicker.value = currentDate;
      refresh(true);
    })();
  </script>
</body>
</html>
